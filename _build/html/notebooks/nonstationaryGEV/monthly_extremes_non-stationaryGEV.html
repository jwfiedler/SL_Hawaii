

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Nonstationary Extremes &#8212; Hawaii Sea Level Indicators</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.5ea377869091fd0449014c60fc090103.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/nonstationaryGEV/monthly_extremes_non-stationaryGEV';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Minor Flood Frequency and Duration" href="../Flood.html" />
    <link rel="prev" title="Components of Sea Level" href="../regional_and_local/SL_Components_annual.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">In development! Please post issues and suggestions to github.</div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/trend_map.png" class="logo__image only-light" alt="Hawaii Sea Level Indicators - Home"/>
    <script>document.write(`<img src="../../_static/trend_map.png" class="logo__image only-dark" alt="Hawaii Sea Level Indicators - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../gettingStarted.html">Getting Started</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../setup.html">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../SL_Data_Wrangling.html">Data Wrangling</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">ANNUAL</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../SL_annual.html">Sea Level Magnitude</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../regional_and_local/SL_Trend.html">Sea Level Trend</a></li>
<li class="toctree-l2"><a class="reference internal" href="../regional_and_local/SL_anomaly_annual.html">Annual Sea Level Anomalies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../regional_and_local/SL_Rankings_annual.html">Annual Sea Level Rankings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../regional_and_local/SL_Extremes_annual.html">Annual Extremes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../regional_and_local/SL_Components_annual.html">Components of Sea Level</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Nonstationary Extremes</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Flood.html">Minor Flood Frequency and Duration</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../FloodFrequency.html">Minor Flood Frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FloodDuration.html">Flood Duration</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">INTRA-ANNUAL</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../SL_intra-annual.html">Sea Level Magnitude</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../regional_and_local/SL_anomaly_intra-annual.html">Intra-Annual Sea Level Anomalies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../regional_and_local/SL_Extremes_intra-annual.html">Intra-Annual Extremes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../regional_and_local/SL_Components_intra-annual.html">Components of Sea Level</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Flood_intra-annual.html">Minor Flood Frequency and Duration</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../FloodFrequency_intra-annual.html">Minor Flood Frequency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FloodDuration_intra-annual.html">Flood Duration</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/jwfiedler/SL_Hawaii/main?urlpath=tree/notebooks/nonstationaryGEV/monthly_extremes_non-stationaryGEV.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/jwfiedler/SL_Hawaii" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/jwfiedler/SL_Hawaii/edit/main/notebooks/nonstationaryGEV/monthly_extremes_non-stationaryGEV.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/jwfiedler/SL_Hawaii/issues/new?title=Issue%20on%20page%20%2Fnotebooks/nonstationaryGEV/monthly_extremes_non-stationaryGEV.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/nonstationaryGEV/monthly_extremes_non-stationaryGEV.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Nonstationary Extremes</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cumulative-distribution-function-cdf">Cumulative Distribution Function (CDF)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#main-functions">Main Functions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-wise-solver">Step-wise solver</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#maximum-likelihood-estimation">Maximum Likelihood Estimation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-search">Parameter Search</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonality-in-location-model">Seasonality in Location Model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonality-trend-and-covariate-model">Seasonality, Trend, and Covariate Model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonality-trend-covariate-and-nodal-cycle-model">Seasonality, Trend, Covariate and Nodal cycle Model</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#input-to-the-fitness-function">Input to the fitness function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-seasonality-effect-on-extremes">Plot: Seasonality Effect on Extremes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#format-data-input-to-the-model">Format data input to the model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adjust-data-for-storm-year">Adjust data for storm year</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-the-covariate-data-timeseries">Prepare the covariate data timeseries.</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#first-look-modeling-seasonality">First look: Modeling Seasonality</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-a-timeseries-of-the-time-dependent-return-values">Extract a timeseries of the time-dependent return values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-confidence-intervals">Calculate Confidence Intervals</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-the-time-dependent-return-value">Calculate the Time Dependent Return Value</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-monthly-extremes-and-given-year-return-period-with-the-seasonal-model">Plot monthly extremes and given year return period with the seasonal model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-if-we-should-include-a-long-term-trend-mean-sea-level-rise-in-our-location-parameter">Check if we should include a long-term trend (mean sea level rise) in our location parameter</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-covariate-in-the-location-parameter">Check the covariate in the location parameter.</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-covariate-in-scale-parameter">Check the covariate in scale parameter</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-nodal-cycle-in-location-parameter">Check the nodal cycle in Location parameter</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-the-timeseries">Plot the timeseries</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-it-up">Plot it up</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-combined-dataset-for-further-plotting-and-analysis">Create a combined dataset for further plotting and analysis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-map">Create a Map</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="nonstationary-extremes">
<h1>Nonstationary Extremes<a class="headerlink" href="#nonstationary-extremes" title="Permalink to this heading">#</a></h1>
<p>As with our stationary annual extremes, for the nonstationary extremes we’ll be using the Generalized Extreme Value (GEV) distribution. The GEV is a family of continuous probability distributions developed to combine the Gumbel, Fréchet, and Weibull families, also known as type I, II, and III extreme value distributions, respectively. It is widely used in different fields, particularly for modeling the largest or smallest values among a large set of independent, identically distributed random values (extreme value analysis).</p>
<section id="cumulative-distribution-function-cdf">
<h2>Cumulative Distribution Function (CDF)<a class="headerlink" href="#cumulative-distribution-function-cdf" title="Permalink to this heading">#</a></h2>
<p>The cumulative distribution function of the GEV, which is used to calculate return periods, is given by:</p>
<div class="amsmath math notranslate nohighlight" id="equation-e3277651-28a5-4d5a-bae6-e8147bb660e0">
<span class="eqno">(1)<a class="headerlink" href="#equation-e3277651-28a5-4d5a-bae6-e8147bb660e0" title="Permalink to this equation">#</a></span>\[\begin{align}
F(x; \mu, \sigma, \xi) = \begin{cases} 
\exp\left(-\left(1 + \xi \frac{x - \mu}{\psi}\right)^{-\frac{1}{\xi}}\right) &amp; \text{if } \xi \neq 0, \; 1 + \xi \frac{x - \mu}{\psi} &gt; 0 \\
\exp\left(-\exp\left(-\frac{x - \mu}{\psi}\right)\right) &amp; \text{if } \xi = 0
\end{cases}
\end{align}\]</div>
<p>Where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\mu \)</span> (location parameter) determines the center of the distribution.</p></li>
<li><p><span class="math notranslate nohighlight">\( \psi \)</span> (scale parameter) is strictly positive and scales the distribution.</p></li>
<li><p><span class="math notranslate nohighlight">\( \xi \)</span> (shape parameter) describes the tail behavior of the distribution. It can be positive (heavy tail, Fréchet), zero (exponential tail, Gumbel), or negative (bounded tail, Weibull).</p></li>
</ul>
<p>Assuming we are not dealing with a random stationary process (as with our stationary annual extremes), each parameter in the above equation can be the combination of one or more time-dependent components. These effects could include annual variability (seasonality), sea level rise (long-term trend and possible acceleration), a long-term trend for the extreme values, long-term climate variability effects explained by climate indices or the 18.61-yr nodal cycle.</p>
<p>The sum total of these covariates on each parameter are:</p>
<div class="amsmath math notranslate nohighlight" id="equation-6615ec0f-a618-4fcd-b727-5427ffe95274">
<span class="eqno">(2)<a class="headerlink" href="#equation-6615ec0f-a618-4fcd-b727-5427ffe95274" title="Permalink to this equation">#</a></span>\[\begin{align}
\mu(t) &amp;= \mu_{SLR}(t) + \mu_S(t)exp^{[\mu_{LT}(t)]} + \mu_N(t) + \mu_{CLI}(t),\\
\psi_t(t) &amp;= \psi_S(t)exp^{[\psi_{LT}(t)]} + \psi_N(t) + \psi_{CLI},\\
\xi_t(t) &amp;= \xi_S(t)exp^{[\xi_{LT}(t)]}
\end{align}\]</div>
<p>Note this includes a nonlinear component to allow for a long-term (LT) variability in the seasonality (S) in the location and scale parameters. The following codes will not include some of these terms - this is a general equation!</p>
<p>This example script explores the following steps:</p>
<ul class="simple">
<li><p>step1: seasonal pattern of extreme events (seasonality on location, scale, and shape parameters remain constant)</p></li>
<li><p>step2: long-term trends in location parameter (linear and a possible acceleration)</p></li>
<li><p>step3: Checking Covariate (ONI index) in the GEV location parameter</p></li>
<li><p>step4: Checking Covariate (ONI index) in the GEV scale parameter</p></li>
<li><p>step5: Checking Nodal cycle (18.6 year period, waves) in the GEV location parameter</p></li>
</ul>
<p>Author: Melisa Menendez, menendezm&#64;unican.es</p>
<p>Updated for Billy &amp; Ayesha SERDP work: 09-March-2017</p>
<p>Updated for Python with some added explanation: July 2024</p>
<p>Further explanation of this code (and writeup) can be found in:
Méndez, F. J., M. Menéndez, A. Luceño, and I. J. Losada, 2007: Analyzing Monthly Extreme Sea Levels with a Time-Dependent GEV Model. J. Atmos. Oceanic Technol., 24, 894–911, https://doi.org/10.1175/JTECH2009.1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.io</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">brentq</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">json</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="main-functions">
<h2>Main Functions<a class="headerlink" href="#main-functions" title="Permalink to this heading">#</a></h2>
<p>Here we’ll write our main functions.</p>
<section id="step-wise-solver">
<h3>Step-wise solver<a class="headerlink" href="#step-wise-solver" title="Permalink to this heading">#</a></h3>
<p>This function iteratively improves the model solution by choosing which parameters to use and evaluating if the change leads to a statistically significant improvement using a <span class="math notranslate nohighlight">\(\chi^2\)</span> metric.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">stepwise</span><span class="p">(</span><span class="n">x_inisol</span><span class="p">,</span> <span class="n">modelType</span><span class="o">=</span><span class="s1">&#39;GEV_SeasonalMu&#39;</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_inisol</span><span class="p">)</span>


    <span class="n">cont</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_inisol</span><span class="p">])</span> 
    <span class="c1"># x = x_inisol # Start with initial solution</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">pa</span> <span class="o">=</span> <span class="n">fitness</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">cont</span><span class="p">],</span> <span class="n">modelType</span><span class="p">)</span>  <span class="c1"># Compute fitness for initial solution</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="p">])</span>
    <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pa</span><span class="p">])</span>
    
    <span class="n">better</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="mf">0.95</span>
    
    <span class="k">while</span> <span class="n">better</span><span class="p">:</span>

        <span class="n">dum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">cont</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Find positions of zeros in the chromosome</span>
        
        <span class="k">if</span> <span class="n">dum</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">cont</span><span class="p">],</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dum</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">f_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dum</span><span class="p">))</span>
            <span class="n">pa_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dum</span><span class="p">))</span>
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dum</span><span class="p">)):</span>
                <span class="n">x_temp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">dum</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">f_temp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pa_temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitness</span><span class="p">(</span><span class="n">x_temp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">modelType</span><span class="p">)</span>
            <span class="n">best</span><span class="p">,</span> <span class="n">indi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f_temp</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">f_temp</span><span class="p">)</span>
            <span class="c1"># Check if the improvement is significant with chi2 test</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">best</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="n">cont</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="p">(</span><span class="n">pa_temp</span><span class="p">[</span><span class="n">indi</span><span class="p">]</span> <span class="o">-</span> <span class="n">pa</span><span class="p">[</span><span class="n">cont</span><span class="p">]))):</span>
                <span class="n">cont</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">x_temp</span><span class="p">[</span><span class="n">indi</span><span class="p">]]))</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">f</span><span class="p">,</span> <span class="p">[</span><span class="n">best</span><span class="p">]))</span>
                <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">pa</span><span class="p">,</span> <span class="p">[</span><span class="n">pa_temp</span><span class="p">[</span><span class="n">indi</span><span class="p">]]))</span>
                <span class="n">f</span><span class="p">[</span><span class="n">cont</span><span class="p">],</span> <span class="n">pa</span><span class="p">[</span><span class="n">cont</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitness</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">cont</span><span class="p">],</span> <span class="n">modelType</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">better</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">better</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="maximum-likelihood-estimation">
<h3>Maximum Likelihood Estimation<a class="headerlink" href="#maximum-likelihood-estimation" title="Permalink to this heading">#</a></h3>
<p>Since we are using monthly data, we can define our location parameter as a harmonic series to represent seasonal effects, like so:</p>
<aside class="margin sidebar">
<p class="sidebar-title"></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that some portions of the original code have a dyadic series, so while our normal series would have n going from 1 to <span class="math notranslate nohighlight">\(\infty\)</span> we will have <span class="math notranslate nohighlight">\(n=1,2,4\)</span>, representing the annual cycle, the seasonal cycle, and the quarterly cycle. (We neglect a tri-annual cycle.)</p>
</div>
</aside>
<div class="math notranslate nohighlight">
\[
f(t) = A_0 + \sum_{n=1}^{\infty} \left( A_n \cos(2n \pi t) + B_n \sin(2n \pi t) \right),
\]</div>
<p>For example, if we can describe our location, scale and shape parameters in the GEV as:</p>
<div class="amsmath math notranslate nohighlight" id="equation-a313de60-3573-4d37-b91f-54e9e3604536">
<span class="eqno">(3)<a class="headerlink" href="#equation-a313de60-3573-4d37-b91f-54e9e3604536" title="Permalink to this equation">#</a></span>\[\begin{align}
\mu(t) &amp;= \beta_{SLR}(t) + [\beta_0 + \beta_1 cos(2\pi t) + \beta_2 sin(2\pi t) + \beta_3 cos(4\pi t) + \beta_4 sin(4\pi t)]e^{[\beta_{LT}(t)]}\\\
 &amp;+ \beta_{N_1} cos(2\pi t/T_N) + \beta_{N_2} sin(2\pi t/T_N) + \beta_{ONI}ONI(t),\\
\psi(t) &amp;= [\alpha_0 + \alpha_1 cos(2\pi t) + \alpha_2 sin(2\pi t)]e^{[\alpha_{LT}(t)]} \\
\xi(t) &amp;=  [\gamma_0 + \gamma_1 cos(2\pi t) + \gamma_2 sin(2\pi t)]
\end{align}\]</div>
<p>then the vector we’d use for our MLE fit should be</p>
<p><span class="math notranslate nohighlight">\(\theta = (\beta_0,\beta_1,\beta_2,\beta_3,\beta_4,\beta_{N_1},\beta_{N_2},\beta_{LT},\beta_{ONI},\alpha_0, \alpha_1, \alpha_2, \alpha_{LT},\gamma_0,\gamma_1,\gamma_2)\)</span>.</p>
<p>Here, <span class="math notranslate nohighlight">\(\beta_{0,1,2,3,4}\)</span> model the seasonal variation of the location parameter, <span class="math notranslate nohighlight">\(\beta_{N1,N2}\)</span> are the amplitudes of the nodal cycle, <span class="math notranslate nohighlight">\(\beta_{LT}\)</span> is the long term trend of the location parameter, and <span class="math notranslate nohighlight">\(\beta_{ONI}\)</span> is the amplitude (relative influence) of the [ONI] climate index in the location parameter. Similarly, <span class="math notranslate nohighlight">\(\alpha_{0,1,2}\)</span> model the [cyclical] variation of the scale parameter, and <span class="math notranslate nohighlight">\(\alpha_{LT}\)</span> models its long-term trend. For the shape parameter, only the seasonal variation is modeled (<span class="math notranslate nohighlight">\(\gamma_{0,1,2}\)</span>).</p>
<p>We’ll use this vector <span class="math notranslate nohighlight">\(\theta\)</span> to calculate the maximum likelihood function <span class="math notranslate nohighlight">\(L\)</span>,</p>
<p><span class="math notranslate nohighlight">\(L(\theta | t_i,z_i) = \prod_{i=1}^m g[z_i;\mu(t_i),\psi(t_i),\xi(t_i)]\)</span>,</p>
<p>where <span class="math notranslate nohighlight">\(g\)</span> is the PDF of the GEV (equation 1). In other words, this means that the likelihood of observing the entire dataset is the product of the likelihoods of observing each individual time point under the assumed GEV model (Maximum Likelihood Estimation, MLE).</p>
</section>
<section id="parameter-search">
<h3>Parameter Search<a class="headerlink" href="#parameter-search" title="Permalink to this heading">#</a></h3>
<p>The code below takes a varying number of parameters (a differently sized vector of regression parameters) for different models. There are three models we can run: GEV_SeasonalMu, GEV_S_T_Cv, or GEV_S_T_Cv_Nodal. Because there are so many parameters to estimate (a high-dimensional problem), a Shuffled Complex Evolution (SCE-UA,\cite{Duan}) optimization scheme is used to determine the best parameter fits. The SCE-UA is used often in hydrology, engineering, and other environmental sciences, using random clusters for initial starting points in its search algorithm and allowing them to “evolve” to a better solution. Other optimization schemes exist, but for now this is what we’re using.</p>
<aside class="margin sidebar">
<p class="sidebar-title"></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Still to do: get these models to run all in a python ecosystem. For right now, they will remain .exe files.</p>
</div>
</aside>
<section id="seasonality-in-location-model">
<h4>Seasonality in Location Model<a class="headerlink" href="#seasonality-in-location-model" title="Permalink to this heading">#</a></h4>
<p>Our first step is to look at seasonality only, using the GEV_SeasonalMu model, such that <span class="math notranslate nohighlight">\(\mu(t)\)</span>, <span class="math notranslate nohighlight">\(\psi(t)\)</span>, and <span class="math notranslate nohighlight">\(\xi(t)\)</span> are:</p>
<div class="amsmath math notranslate nohighlight" id="equation-50a31d9b-29e3-4a6d-93e2-c16bf145e040">
<span class="eqno">(4)<a class="headerlink" href="#equation-50a31d9b-29e3-4a6d-93e2-c16bf145e040" title="Permalink to this equation">#</a></span>\[\begin{align}
\mu(t) &amp;=  \beta_0 + \beta_1 cos(2\pi t) + \beta_2 sin(2\pi t) + \\
&amp;\beta_3 cos(4\pi t) + \beta_4 sin(4\pi t) + \beta_5 cos(8\pi t) + \beta_6 sin(8\pi t),\\
\psi &amp;= \alpha_0, \\
\xi &amp;=  \gamma_0 
\end{align}\]</div>
<p>and we’ll arrange our vector of 9 regression parameters within the fitness function like so:</p>
<p><span class="math notranslate nohighlight">\(\theta = [\beta_0, \alpha_0, \gamma_0, \beta_1, \beta_2, \beta_3, \beta_4, \beta_5, \beta_6].\)</span></p>
<p>In this way we assume that only the location parameter changes within a year, whereas the shape and scale of the GEV distribution are constant.</p>
</section>
<section id="seasonality-trend-and-covariate-model">
<h4>Seasonality, Trend, and Covariate Model<a class="headerlink" href="#seasonality-trend-and-covariate-model" title="Permalink to this heading">#</a></h4>
<p>For the GEV_S_T_Cv model , we’ll allow a long-term trend into the location parameter and a covariate into the scale and location parameter:</p>
<aside class="margin sidebar">
<p class="sidebar-title"></p>
<p>Note this trend can be approximated as linear if our long-term trend parameter <span class="math notranslate nohighlight">\(\beta_{LT}\)</span> is small.</p>
<p>Mathmematically, as <span class="math notranslate nohighlight">\(\beta_{LT}\)</span> goes to zero, <span class="math notranslate nohighlight">\(e^{\beta_{LT}·t}\)</span> goes to <span class="math notranslate nohighlight">\(1 + \beta_{LT}·t\)</span> and our expression (for the non-cyclical part of the location parameter) simplifies to <span class="math notranslate nohighlight">\(\beta_0 (1 +  \beta_{LT}·t)\)</span>.</p>
<p>That is the equation of a line: <span class="math notranslate nohighlight">\(\beta_0 + \beta_0·\beta_{LT}·t\)</span>, where slope of the line is <span class="math notranslate nohighlight">\(\beta_0·\beta_{LT}\)</span>.</p>
</aside>
<div class="amsmath math notranslate nohighlight" id="equation-ee89bd40-36ae-48e0-ad6d-a25d1f37db1c">
<span class="eqno">(5)<a class="headerlink" href="#equation-ee89bd40-36ae-48e0-ad6d-a25d1f37db1c" title="Permalink to this equation">#</a></span>\[\begin{align}
\mu(t) &amp;= \beta_0e^{\beta_{LT}(t)}  + \beta_1 cos(2\pi t) + \beta_2 sin(2\pi t) + \beta_3 cos(4\pi t) + \beta_4 sin(4\pi t) \\
&amp;+ \beta_5 cos(8\pi t) + \beta_6 sin(8\pi t)   + \beta_{ONI}ONI(t),\\
\psi &amp;= \alpha_0 + \alpha_{ONI}ONI(t), \\
\xi &amp;=  \gamma_0 
\end{align}\]</div>
<p>and we’ll arrange our vector of 12 regression parameters within the fitness function like so:</p>
<p><span class="math notranslate nohighlight">\(\theta = [\beta_0, \alpha_0, \gamma_0, \beta_1, \beta_2, \beta_3, \beta_4, \beta_5, \beta_6,\beta_{LT},\beta_{ONI},\alpha_{ONI}].\)</span></p>
</section>
<section id="seasonality-trend-covariate-and-nodal-cycle-model">
<h4>Seasonality, Trend, Covariate and Nodal cycle Model<a class="headerlink" href="#seasonality-trend-covariate-and-nodal-cycle-model" title="Permalink to this heading">#</a></h4>
<p>For the GEV_S_T_Cv_N model , we’ll add in the nodal cycle:</p>
<div class="amsmath math notranslate nohighlight" id="equation-518c81ef-a3cc-4bbf-bc51-17bda8204260">
<span class="eqno">(6)<a class="headerlink" href="#equation-518c81ef-a3cc-4bbf-bc51-17bda8204260" title="Permalink to this equation">#</a></span>\[\begin{align}
\mu(t) &amp;= \beta_0 e^{\beta_{LT}(t)} + \beta_1 cos(2\pi t) + \beta_2 sin(2\pi t) + \beta_3 cos(4\pi t) + \beta_4 sin(4\pi t) \\
&amp;+ \beta_5 cos(8\pi t) + \beta_6 sin(8\pi t) + \beta_{ONI}ONI(t) + \beta_{N_1} cos(2\pi t/T_N),\\
\psi &amp;= \alpha_0 + \alpha_{ONI}ONI(t), \\
\xi &amp;=  \gamma_0 
\end{align}\]</div>
<p>and we’ll arrange our vector of 14 regression parameters within the fitness function like so:</p>
<p><span class="math notranslate nohighlight">\(\theta = [\beta_0, \alpha_0, \gamma_0, \beta_1, \beta_2, \beta_3, \beta_4, \beta_5, \beta_6,\beta_{LT},\beta_{ONI},\alpha_{ONI},\beta_{N1},\beta_{N2}].\)</span></p>
</section>
</section>
<section id="input-to-the-fitness-function">
<h3>Input to the fitness function<a class="headerlink" href="#input-to-the-fitness-function" title="Permalink to this heading">#</a></h3>
<p>Note that the input “x” to the fitness function works like a switch - if it is a parameter to include, it is 1 (True). If it is not used, it is 0 (False). It is at most 7 elements long.</p>
<ul class="simple">
<li><p>x: [1/0 1/0 1/0 1/0 1/0 1/0 1/0]</p></li>
<li><p>x[0]: annual cycle, location parameter.</p></li>
<li><p>x[1]: semi-annual cycle, location parameter.</p></li>
<li><p>x[2]: quarterly cycle, location parameter.</p></li>
<li><p>x[3]: Trend, location parameter.</p></li>
<li><p>x[4]: Covariate, location parameter.</p></li>
<li><p>x[5]: Covariate, scale parameter.</p></li>
<li><p>x[6]: Nodal cycle, location parameter</p></li>
<li><p>Max number of parameters: 14</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fitness</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">modelType</span><span class="o">=</span><span class="s1">&#39;GEV_SeasonalMu&#39;</span><span class="p">):</span>
    <span class="c1"># Load parameter limits from a file</span>
    <span class="n">aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;limits.txt&#39;</span><span class="p">)</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aux</span><span class="p">))</span>  <span class="c1"># Initialize with NaNs</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aux</span><span class="p">))</span>
    <span class="c1"># Initialize parameter limits based on the chromosome</span>
    <span class="n">xmin</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">xmax</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">cont</span> <span class="o">=</span> <span class="mi">3</span>
    

    <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Annual cycle</span>
        <span class="n">xmin</span><span class="p">[</span><span class="n">cont</span><span class="p">:</span><span class="n">cont</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">aux</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">aux</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>  <span class="c1"># should use indices 3 and 4 (i.e., aux(4,1) and aux(5,1) in MATLAB)</span>
        <span class="n">xmax</span><span class="p">[</span><span class="n">cont</span><span class="p">:</span><span class="n">cont</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">aux</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">aux</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="n">cont</span> <span class="o">+=</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Semiannual cycle</span>
        <span class="n">xmin</span><span class="p">[</span><span class="n">cont</span><span class="p">:</span><span class="n">cont</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">aux</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">aux</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>  <span class="c1"># should use indices 5 and 6 (i.e., aux(6,1) and aux(7,1) in MATLAB)</span>
        <span class="n">xmax</span><span class="p">[</span><span class="n">cont</span><span class="p">:</span><span class="n">cont</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">aux</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">aux</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="n">cont</span> <span class="o">+=</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Frequency 4w</span>
        <span class="n">xmin</span><span class="p">[</span><span class="n">cont</span><span class="p">:</span><span class="n">cont</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">aux</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">aux</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>  <span class="c1"># should use indices 5 and 6 (same as Semiannual cycle)</span>
        <span class="n">xmax</span><span class="p">[</span><span class="n">cont</span><span class="p">:</span><span class="n">cont</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">aux</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">aux</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="n">cont</span> <span class="o">+=</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">modelType</span> <span class="o">==</span> <span class="s1">&#39;GEV_S_T_Cv&#39;</span> <span class="ow">or</span> <span class="n">modelType</span> <span class="o">==</span> <span class="s1">&#39;GEV_S_T_Cv_Nodal&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Frequency 4w, for some reason the limits change, so we&#39;ll replace them</span>
            <span class="n">cont</span> <span class="o">-=</span> <span class="mi">2</span>
            <span class="n">xmin</span><span class="p">[</span><span class="n">cont</span><span class="p">:</span><span class="n">cont</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">aux</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">aux</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>  <span class="c1"># </span>
            <span class="n">xmax</span><span class="p">[</span><span class="n">cont</span><span class="p">:</span><span class="n">cont</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">aux</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">aux</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="n">cont</span> <span class="o">+=</span> <span class="mi">2</span>
        
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># Trend in location parameter, beta_LT</span>
            <span class="n">xmin</span><span class="p">[</span><span class="n">cont</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">xmax</span><span class="p">[</span><span class="n">cont</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">cont</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># Covariate in location parameter, beta_CV</span>
            <span class="n">xmin</span><span class="p">[</span><span class="n">cont</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">xmax</span><span class="p">[</span><span class="n">cont</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">cont</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># Covariate in scale parameter, gamma_CV</span>
            <span class="n">xmin</span><span class="p">[</span><span class="n">cont</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">xmax</span><span class="p">[</span><span class="n">cont</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">cont</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">if</span> <span class="n">modelType</span> <span class="o">==</span> <span class="s1">&#39;GEV_S_T_Cv_Nodal&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># Nodal component in location, beta_N1, beta_N2</span>
            <span class="n">xmin</span><span class="p">[</span><span class="n">cont</span><span class="p">:</span><span class="n">cont</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">aux</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">aux</span><span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
            <span class="n">xmax</span><span class="p">[</span><span class="n">cont</span><span class="p">:</span><span class="n">cont</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">aux</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">aux</span><span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="n">cont</span> <span class="o">+=</span> <span class="mi">2</span>


    <span class="n">xmin</span> <span class="o">=</span> <span class="n">xmin</span><span class="p">[:</span><span class="n">cont</span><span class="p">]</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">xmax</span><span class="p">[:</span><span class="n">cont</span><span class="p">]</span>

    <span class="c1"># Prepare the initial values and parameter configuration file</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xmin</span><span class="p">)</span>
    <span class="n">xini</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001</span>
    <span class="n">xini</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.001</span>  <span class="c1"># Specific initialization for third parameter</span>
    
    <span class="c1"># Prepare parameters for the external executable</span>
    <span class="n">maxn</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2000</span> <span class="o">+</span> <span class="mi">1500</span> <span class="o">*</span> <span class="n">n</span> <span class="c1">#number of iterations</span>
    <span class="n">kstop</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1">#number of iterations without improvement allowed</span>
    <span class="n">pcento</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">ngs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">iseed</span> <span class="o">=</span> <span class="mi">955</span>
    <span class="n">ideflt</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">npg</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">nps</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">nspl</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">mings</span> <span class="o">=</span> <span class="n">ngs</span>
    <span class="n">iniflg</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">iprint</span> <span class="o">=</span> <span class="mi">0</span>
    

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;scein.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># Writing header with specified formatting</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">maxn</span><span class="si">:</span><span class="s2">5g</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">kstop</span><span class="si">:</span><span class="s2">5g</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">pcento</span><span class="si">:</span><span class="s2">5.3g</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ngs</span><span class="si">:</span><span class="s2">5g</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">iseed</span><span class="si">:</span><span class="s2">5g</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ideflt</span><span class="si">:</span><span class="s2">5g</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">npg</span><span class="si">:</span><span class="s2">5g</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">nps</span><span class="si">:</span><span class="s2">5g</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">nspl</span><span class="si">:</span><span class="s2">5g</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">mings</span><span class="si">:</span><span class="s2">5g</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">iniflg</span><span class="si">:</span><span class="s2">5g</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">iprint</span><span class="si">:</span><span class="s2">5g</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Write chromosome values with better control over formatting</span>
        <span class="n">x_formatted</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">:</span><span class="s2">1.0f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="si">:</span><span class="s2">1.0f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x_formatted</span><span class="p">)</span>

        <span class="c1"># Writing parameter limits and initial guesses with specified precision</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xini</span><span class="p">)):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">xini</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">15.8f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">xmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">15.8f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">xmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">15.8f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>        

    
    <span class="c1"># Run the external model executable</span>
    <span class="n">modelName</span> <span class="o">=</span> <span class="s1">&#39;Model_&#39;</span> <span class="o">+</span> <span class="n">modelType</span> <span class="o">+</span> <span class="s1">&#39;.exe&#39;</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">modelName</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Read the output</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;best.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">bestf</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    
    <span class="k">return</span> <span class="n">bestf</span><span class="p">,</span> <span class="n">n</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="plot-seasonality-effect-on-extremes">
<h3>Plot: Seasonality Effect on Extremes<a class="headerlink" href="#plot-seasonality-effect-on-extremes" title="Permalink to this heading">#</a></h3>
<p>Next we’ll make an example plot of the seasonality effect on extremes. For each year day, we’ll evaluate the CDF of the GEV at a return period of 50 years to get the the return levels within the year.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plottingExtremeSeasonality</span><span class="p">(</span><span class="n">T0</span><span class="p">,</span> <span class="n">seaLevel</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ReturnPeriod</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">SampleRate</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.101</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
    
    <span class="c1"># Define the mu using the harmonic series</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t2</span><span class="p">)</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t2</span><span class="p">)</span> <span class="o">+</span>
          <span class="n">w</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t2</span><span class="p">)</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t2</span><span class="p">)</span> <span class="o">+</span>
          <span class="n">w</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t2</span><span class="p">)</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t2</span><span class="p">))</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="c1"># Define the time within the year</span>
    <span class="n">twinthinyear</span> <span class="o">=</span><span class="n">T0</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">T0</span><span class="p">)</span>
    
    <span class="n">T</span> <span class="o">=</span> <span class="n">T0</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">ReturnPeriod</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">SampleRate</span>

    <span class="c1"># get seaLevelS for all ReturnPeriods</span>
    <span class="c1"># preallocate seaLevelS with Nans for each ReturnPeriod</span>
    <span class="n">seaLevelS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">t2</span><span class="p">)))</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)):</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">S</span><span class="p">))</span> <span class="c1">### ALTERED FROM MATLAB CODE!!! ###</span>
        <span class="n">seaLevelS</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">-</span> <span class="p">(</span><span class="n">psi</span><span class="o">/</span><span class="n">xi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">xi</span><span class="p">))</span>
    
    
    <span class="n">serieCV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
    
    <span class="c1"># Find the root of the Quantilentime function</span>
    <span class="k">def</span> <span class="nf">Quantilentime</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
        <span class="n">t00</span><span class="p">,</span> <span class="n">t11</span> <span class="o">=</span> <span class="mf">0.00001</span><span class="p">,</span> <span class="mf">1.00001</span>  <span class="c1"># Define the time bounds if not globally available</span>

        <span class="c1"># Variables previously defined as global in MATLAB code, handled here locally</span>
        <span class="n">b0</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">b4</span><span class="p">,</span> <span class="n">b5</span><span class="p">,</span> <span class="n">b6</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">a0</span><span class="p">,</span> <span class="n">bLT</span><span class="p">,</span> <span class="n">bCI</span><span class="p">,</span> <span class="n">aCI</span><span class="p">,</span> <span class="n">bN1</span><span class="p">,</span> <span class="n">bN2</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">km</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.001</span>
        <span class="n">ti</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t00</span><span class="p">,</span> <span class="n">t11</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

        <span class="c1"># Interpolate serieCV at ti points</span>
        <span class="n">serieCV2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">serieCV</span><span class="p">)</span>
        <span class="c1"># Replace NaNs with zero (np.interp does this by default if outside the bounds)</span>
        <span class="n">serieCV2</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">serieCV2</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Define mut (location(t)) and other parameters</span>
        <span class="n">mut</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">bLT</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">+</span>
               <span class="n">b1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">+</span> <span class="n">b2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">+</span>
               <span class="n">b3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">+</span> <span class="n">b4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">+</span>
               <span class="n">b5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">+</span> <span class="n">b6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">+</span>
               <span class="n">bN1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">18.61</span><span class="p">)</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">+</span> <span class="n">bN2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">18.61</span><span class="p">)</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">+</span>
               <span class="p">(</span><span class="n">bCI</span> <span class="o">*</span> <span class="n">serieCV2</span><span class="p">))</span>

        <span class="n">psi</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">+</span> <span class="p">(</span><span class="n">aCI</span> <span class="o">*</span> <span class="n">serieCV2</span><span class="p">)</span>
        <span class="n">xit</span> <span class="o">=</span> <span class="n">xi</span>

        <span class="c1"># Calculate factor, equation 10 in Menendez and Woodworth (2009)</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ti</span><span class="p">)):</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">xit</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">mut</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">psi</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="mf">0.0001</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">xit</span><span class="p">)</span>
            <span class="n">factor</span> <span class="o">+=</span> <span class="n">h</span>

        <span class="n">Pr</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">R</span><span class="p">)</span>
        
        <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">Pr</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">km</span> <span class="o">*</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">y</span>
    
    <span class="n">YY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">))</span>  <span class="c1"># Preallocate for storing results</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">R</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ReturnPeriod</span><span class="p">):</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">YY</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span><span class="n">Quantilentime</span><span class="p">,</span> <span class="n">x0</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="n">x0</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">R</span><span class="p">,))</span>  <span class="c1"># using bracketing to find the root of Quantilentime function instead of fsolve</span>
    
   <span class="c1"># Start plotting</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">sss</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">()</span>

    
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">R</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ReturnPeriod</span><span class="p">):</span>
        <span class="n">sss</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">seaLevelS</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">STNDtoMHHW</span><span class="p">,</span> <span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">sss</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t2</span><span class="p">))</span> <span class="o">*</span> <span class="n">YY</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">STNDtoMHHW</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;R=</span><span class="si">{</span><span class="n">R</span><span class="si">}</span><span class="s1"> years&#39;</span><span class="p">)</span>
    <span class="n">sss</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">twinthinyear</span><span class="p">,</span> <span class="n">seaLevel</span><span class="o">-</span><span class="n">STNDtoMHHW</span><span class="p">,</span> <span class="s1">&#39;+k&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Monthly maxima&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sss</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># arrange yaxis for breathing room</span>
    <span class="n">meanmaxSL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">seaLevel</span><span class="o">-</span><span class="n">STNDtoMHHW</span><span class="p">)</span>
    <span class="n">rangemaxSL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">seaLevel</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">seaLevel</span><span class="p">)</span> <span class="c1"># Range</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.001</span><span class="p">,</span> <span class="n">meanmaxSL</span><span class="o">-</span><span class="n">rangemaxSL</span><span class="p">,</span> <span class="n">meanmaxSL</span><span class="o">+</span><span class="n">rangemaxSL</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.08333</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;Jan&#39;</span><span class="p">,</span> <span class="s1">&#39;Mar&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;Jul&#39;</span><span class="p">,</span> <span class="s1">&#39;Sep&#39;</span><span class="p">,</span> <span class="s1">&#39;Nov&#39;</span><span class="p">])</span>
    
    <span class="c1"># add legend</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">))</span>

    
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sea level (m, MHHW)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">cmap</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
</section>
<section id="format-data-input-to-the-model">
<h2>Format data input to the model<a class="headerlink" href="#format-data-input-to-the-model" title="Permalink to this heading">#</a></h2>
<p>Now we’ll take our sea level data, extract the monthly maxima from our timeseries, and format it for input into the model. We need the yearday of each monthly maximum, and if using a covariate model (e.g. SOI, ENSO, wave height), the yearday of that index.</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="o">%</span><span class="k">run</span> ../setup.ipynb
<span class="o">%</span><span class="k">run</span> ../plotting_functions.ipynb

<span class="n">data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../../data&#39;</span> <span class="p">)</span>
<span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../../output/extremes&#39;</span><span class="p">)</span> 
<span class="n">input_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./model_input&#39;</span><span class="p">)</span>
<span class="n">model_output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span><span class="s1">&#39;GEV_model_output&#39;</span><span class="p">)</span>
<span class="n">rsl_hourly</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">data_dir</span><span class="o">/</span> <span class="s1">&#39;rsl_hawaii.nc&#39;</span><span class="p">)</span>

<span class="c1"># remove stations 547,548, 14</span>
<span class="n">rsl_hourly</span> <span class="o">=</span> <span class="n">rsl_hourly</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">record_id</span><span class="o">=~</span><span class="n">rsl_hourly</span><span class="o">.</span><span class="n">record_id</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">547</span><span class="p">,</span><span class="mi">548</span><span class="p">,</span><span class="mi">14</span><span class="p">]))</span>

<span class="c1"># close the file</span>
<span class="n">rsl_hourly</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="n">runWithoutModel</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># check if output directory exists, if not create it</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># check if model output directory exists, if not create it</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">model_output_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">model_output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># make sub-directories for each station in rsl_hourly in model_output_dir</span>
<span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">rsl_hourly</span><span class="o">.</span><span class="n">record_id</span><span class="p">:</span>
    <span class="n">ridString</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rid</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="c1"># maybe needs some leading zeros, for now we&#39;ll leave it.</span>
    <span class="n">station_dir</span> <span class="o">=</span> <span class="n">model_output_dir</span> <span class="o">/</span> <span class="n">ridString</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">station_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">station_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># remove best.txt, T.txt, CI.txt, Y.txt, mio.txt, scein.dat, and sceout.dat from working directory</span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;best.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;T.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;CI.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;Y.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;mio.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;scein.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;sceout.dat&#39;</span><span class="p">]:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">))</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">))</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\julia\anaconda3\envs\SLI39\lib\site-packages\pyproj\__init__.py:89: UserWarning: pyproj unable to set database path.
  _pyproj_global_context_initialize()
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">line</span> <span class="mi">10</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="n">input_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./model_input&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="n">model_output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span><span class="s1">&#39;GEV_model_output&#39;</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">10</span> <span class="n">rsl_hourly</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">data_dir</span><span class="o">/</span> <span class="s1">&#39;rsl_hawaii.nc&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="c1"># remove stations 547,548, 14</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">rsl_hourly</span> <span class="o">=</span> <span class="n">rsl_hourly</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">record_id</span><span class="o">=~</span><span class="n">rsl_hourly</span><span class="o">.</span><span class="n">record_id</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">547</span><span class="p">,</span><span class="mi">548</span><span class="p">,</span><span class="mi">14</span><span class="p">]))</span>

<span class="nn">File ~\anaconda3\envs\SLI39\lib\site-packages\xarray\backends\api.py:552,</span> in <span class="ni">open_dataset</span><span class="nt">(filename_or_obj, engine, chunks, cache, decode_cf, mask_and_scale, decode_times, decode_timedelta, use_cftime, concat_characters, decode_coords, drop_variables, inline_array, chunked_array_type, from_array_kwargs, backend_kwargs, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">549</span>     <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">backend_kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">551</span> <span class="k">if</span> <span class="n">engine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">552</span>     <span class="n">engine</span> <span class="o">=</span> <span class="n">plugins</span><span class="o">.</span><span class="n">guess_engine</span><span class="p">(</span><span class="n">filename_or_obj</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">554</span> <span class="k">if</span> <span class="n">from_array_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">555</span>     <span class="n">from_array_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

<span class="nn">File ~\anaconda3\envs\SLI39\lib\site-packages\xarray\backends\plugins.py:197,</span> in <span class="ni">guess_engine</span><span class="nt">(store_spec)</span>
<span class="g g-Whitespace">    </span><span class="mi">189</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">190</span>     <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">191</span>         <span class="s2">&quot;found the following matches with the input file in xarray&#39;s IO &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">192</span>         <span class="sa">f</span><span class="s2">&quot;backends: </span><span class="si">{</span><span class="n">compatible_engines</span><span class="si">}</span><span class="s2">. But their dependencies may not be installed, see:</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">193</span>         <span class="s2">&quot;https://docs.xarray.dev/en/stable/user-guide/io.html </span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">194</span>         <span class="s2">&quot;https://docs.xarray.dev/en/stable/getting-started-guide/installing.html&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">195</span>     <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">197</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

<span class="ne">ValueError</span>: did not find a match in any of xarray&#39;s currently installed IO backends [&#39;netcdf4&#39;, &#39;scipy&#39;]. Consider explicitly selecting one of the installed engines via the ``engine`` parameter, or installing additional IO dependencies, see:
<span class="ne">https</span>://docs.xarray.dev/en/stable/getting-started-guide/installing.html
<span class="ne">https</span>://docs.xarray.dev/en/stable/user-guide/io.html
</pre></div>
</div>
</div>
</details>
</div>
<section id="adjust-data-for-storm-year">
<h3>Adjust data for storm year<a class="headerlink" href="#adjust-data-for-storm-year" title="Permalink to this heading">#</a></h3>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Commenting this out for now. Do we want to use storm year?</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # add storm_time to the dataset</span>

<span class="c1"># storm_time = pd.to_datetime(rsl_hourly[&#39;time&#39;].values).to_series() + pd.DateOffset(months=-4)</span>

<span class="c1"># storm_time_da = xr.DataArray(storm_time.values, dims=rsl_hourly[&#39;time&#39;].dims, coords=rsl_hourly[&#39;time&#39;].coords)</span>

<span class="c1"># # Add &#39;storm_time&#39; as a coordinate to the dataset</span>
<span class="c1"># rsl_hourly = rsl_hourly.assign_coords(storm_time=storm_time_da)</span>

<span class="c1"># # Make &#39;storm_time&#39; a dimension</span>
<span class="c1"># rsl_hourly = rsl_hourly.swap_dims({&#39;time&#39;: &#39;storm_time&#39;})</span>

<span class="c1"># # Sort by &#39;storm_time&#39; to ensure monotonic order</span>
<span class="c1"># rsl_hourly = rsl_hourly.sortby(&#39;storm_time&#39;)</span>

<span class="c1"># rsl_hourly</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s print the station names that correspond to order of the data, because I keep forgetting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">rsl_hourly</span><span class="o">.</span><span class="n">station_name</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;Midway&#39; &#39;Johnston&#39; &#39;Honolulu, Hawaii&#39; &#39;Nawiliwili&#39; &#39;Kahului&#39;
 &#39;Hilo, Hawaii&#39; &#39;Mokuoloe&#39; &#39;Kawaihae&#39;]
</pre></div>
</div>
</div>
</div>
<p>The following function reads in the hourly timeseries for a given station (rid = record id) from the rsl_hourly dataset. It returns a dataframe of monthly max sea level values (in STND datum), and time in decimal years, such that the first year of the record starts at 0, and each subsequent time step is fraction of that year.</p>
<aside class="margin sidebar">
<p class="sidebar-title"></p>
<p>TO DO: Adjust monthly maxima timeseries such that high water levels from the same event are not doubly counted.</p>
</aside>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_monthly_max_time_series</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span><span class="n">rsl_hourly</span><span class="p">):</span>
    <span class="n">station_name</span> <span class="o">=</span> <span class="n">rsl_hourly</span><span class="o">.</span><span class="n">station_name</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

    <span class="n">STNDtoMHHW</span> <span class="o">=</span> <span class="mf">0.001</span><span class="o">*</span><span class="n">rsl_hourly</span><span class="p">[</span><span class="s1">&#39;MHHW&#39;</span><span class="p">][</span><span class="n">rid</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">sea_level_series</span> <span class="o">=</span> <span class="mf">0.001</span><span class="o">*</span><span class="n">rsl_hourly</span><span class="p">[</span><span class="s1">&#39;sea_level&#39;</span><span class="p">][</span><span class="n">rid</span><span class="p">]</span>

    <span class="c1">#get only data from 1993 to 2023</span>
    <span class="n">sea_level_series</span> <span class="o">=</span> <span class="n">sea_level_series</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s1">&#39;1993&#39;</span><span class="p">,</span> <span class="s1">&#39;2023&#39;</span><span class="p">))</span>

    <span class="c1"># remove nans</span>
    <span class="n">sea_level_series</span> <span class="o">=</span> <span class="n">sea_level_series</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

    <span class="c1"># Step 1: extract the monthly maxima</span>
    <span class="n">monthly_max</span> <span class="o">=</span> <span class="n">sea_level_series</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s1">&#39;1ME&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># get exact time of the monthly maxima</span>
    <span class="n">t_monthly_max</span> <span class="o">=</span> <span class="n">sea_level_series</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s1">&#39;1ME&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">argmax</span><span class="p">()])</span>

    <span class="c1"># To ensure it&#39;s in datetime format and to access datetime properties</span>
    <span class="n">t_monthly_max</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">t_monthly_max</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># Now extract the day of the year (using fractional days)</span>
    <span class="n">t_yearDay</span> <span class="o">=</span> <span class="n">t_monthly_max</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span> <span class="o">+</span> <span class="n">t_monthly_max</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="o">/</span><span class="mi">24</span> <span class="o">+</span> <span class="n">t_monthly_max</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">minute</span><span class="o">/</span><span class="mi">1440</span> <span class="o">+</span> <span class="n">t_monthly_max</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">second</span><span class="o">/</span><span class="mi">86400</span>

    <span class="c1"># get year of t_monthly_max</span>
    <span class="n">t_year</span> <span class="o">=</span> <span class="n">t_monthly_max</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
    <span class="n">year0</span> <span class="o">=</span> <span class="n">t_year</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

    <span class="c1"># convert t_yearDay and monthly_max to float</span>
    <span class="n">t_yearDay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_yearDay</span><span class="p">)</span>
    <span class="n">monthly_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">monthly_max</span><span class="p">)</span>
    <span class="n">t_monthly_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_monthly_max</span><span class="p">)</span>
    <span class="n">t_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_year</span><span class="p">)</span>

    <span class="c1"># get decimal year such that t = year_monthly_max + t_yearDay/366</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_year</span><span class="o">-</span><span class="n">t_year</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">t_yearDay</span><span class="o">/</span><span class="mi">366</span>

    <span class="c1"># save t and monthly_max to data frame</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span> <span class="s1">&#39;monthly_max&#39;</span><span class="p">:</span> <span class="n">monthly_max</span><span class="p">,</span> <span class="s1">&#39;t_monthly_max&#39;</span><span class="p">:</span> <span class="n">t_monthly_max</span><span class="p">})</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">STNDtoMHHW</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">year0</span>
</pre></div>
</div>
</div>
</div>
<section id="prepare-the-covariate-data-timeseries">
<h4>Prepare the covariate data timeseries.<a class="headerlink" href="#prepare-the-covariate-data-timeseries" title="Permalink to this heading">#</a></h4>
<p>In this case, we’ll be using the ONI data we downloaded earlier in the datawrangling notebook. We’ll also reindex everything to storm year (May-April).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_covariate</span><span class="p">(</span><span class="n">t_monthly_max</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">):</span>
    <span class="n">ONI_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">/</span> <span class="s1">&#39;ONI.csv&#39;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>

    <span class="c1"># drop last 2 columns</span>
    <span class="n">ONI_df</span> <span class="o">=</span> <span class="n">ONI_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">ONI_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Set the Date as the index for easier slicing and access</span>
    <span class="n">ONI_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Reindex to include all necessary dates from t_monthly_max for interpolation</span>
    <span class="n">all_dates</span> <span class="o">=</span> <span class="n">ONI_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">t_monthly_max</span><span class="p">)</span>

    <span class="c1"># Reindex the DataFrame with the union of dates</span>
    <span class="n">ONI_df</span> <span class="o">=</span> <span class="n">ONI_df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">all_dates</span><span class="p">)</span>

    <span class="c1"># Now interpolate </span>
    <span class="n">ONI_interp_df</span> <span class="o">=</span> <span class="n">ONI_df</span><span class="o">.</span><span class="n">interpolate</span><span class="p">()</span>

    <span class="c1"># retrieve the ONI value for the monthly maxima</span>
    <span class="n">ONI_interp</span> <span class="o">=</span> <span class="n">ONI_interp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t_monthly_max</span><span class="p">]</span>

    <span class="c1"># Save ONI_interp as &#39;covariate&#39; as a 1D numpy array</span>
    <span class="n">covariate</span> <span class="o">=</span> <span class="n">ONI_interp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">covariate</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rsl_hourly</span><span class="o">.</span><span class="n">station_name</span><span class="p">)):</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">STNDtoMHHW</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span><span class="n">year0</span> <span class="o">=</span> <span class="n">get_monthly_max_time_series</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span><span class="n">rsl_hourly</span><span class="p">)</span>

    <span class="c1"># add covariate to the data frame</span>
    <span class="n">covariate</span> <span class="o">=</span> <span class="n">get_covariate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;t_monthly_max&#39;</span><span class="p">],</span> <span class="n">data_dir</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ONI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">covariate</span>
    <span class="c1"># save the data frame to a csv file with station record_id</span>
    <span class="n">savename</span> <span class="o">=</span> <span class="s1">&#39;monthly_max_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rsl_hourly</span><span class="o">.</span><span class="n">record_id</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span>
    
    <span class="n">savepath</span> <span class="o">=</span> <span class="n">input_dir</span> <span class="o">/</span> <span class="n">savename</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ii</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">mm</span><span class="p">,</span> <span class="n">STNDtoMHHW</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">year0</span> <span class="o">=</span> <span class="n">get_monthly_max_time_series</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">rsl_hourly</span><span class="p">)</span>
<span class="n">covariate</span> <span class="o">=</span> <span class="n">get_covariate</span><span class="p">(</span><span class="n">mm</span><span class="p">[</span><span class="s1">&#39;t_monthly_max&#39;</span><span class="p">],</span> <span class="n">data_dir</span><span class="p">)</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;station_name&quot;</span><span class="p">,</span> <span class="n">station_name</span><span class="p">)</span>
<span class="n">ridString</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rsl_hourly</span><span class="o">.</span><span class="n">record_id</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="n">savename</span> <span class="o">=</span> <span class="s1">&#39;monthly_max_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rsl_hourly</span><span class="o">.</span><span class="n">record_id</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span>
<span class="n">savepath</span> <span class="o">=</span> <span class="n">input_dir</span> <span class="o">/</span> <span class="n">savename</span>

<span class="c1"># write the data in the csv to text file for model input</span>

<span class="n">mm</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">savepath</span><span class="p">)</span>
<span class="n">mm</span>
<span class="n">mm</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;T.txt&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">mm</span><span class="p">[</span><span class="s1">&#39;monthly_max&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;Y.txt&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">mm</span><span class="p">[</span><span class="s1">&#39;ONI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;CI.txt&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Close rsl_hourly</span>
<span class="n">rsl_hourly</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Honolulu, Hawaii&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="first-look-modeling-seasonality">
<h2>First look: Modeling Seasonality<a class="headerlink" href="#first-look-modeling-seasonality" title="Permalink to this heading">#</a></h2>
<p>Here we’ll look at seasonality in the location parameter only.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initial chromosome setup</span>
<span class="n">x_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_output_dir</span> <span class="o">/</span> <span class="n">ridString</span> <span class="o">/</span> <span class="s1">&#39;seasonal_params.json&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">runWithoutModel</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_output_dir</span> <span class="o">/</span> <span class="n">ridString</span> <span class="o">/</span> <span class="s1">&#39;seasonal_params.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">w_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">])</span>
        <span class="n">x_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
        <span class="n">mio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;mio&#39;</span><span class="p">])</span>
        <span class="n">standard_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;standard_error&#39;</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">x_s</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">stepwise</span><span class="p">(</span><span class="n">x_0</span><span class="p">,</span> <span class="n">modelType</span><span class="o">=</span><span class="s1">&#39;GEV_SeasonalMu&#39;</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">fitness</span><span class="p">(</span><span class="n">x_s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">modelType</span><span class="o">=</span><span class="s1">&#39;GEV_SeasonalMu&#39;</span><span class="p">)</span>
    <span class="n">w_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;best.txt&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">mio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;mio.txt&#39;</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">x_s</span> <span class="o">=</span> <span class="n">x_s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Assess standard errors of the parameters</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">mio</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mio</span><span class="p">)</span>
        <span class="n">standard_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">J</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">standard_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w_s</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>


<span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="n">w_s</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s1">&#39;mio&#39;</span><span class="p">:</span> <span class="n">mio</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s1">&#39;standard_error&#39;</span><span class="p">:</span> <span class="n">standard_error</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x_s</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
<span class="n">savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_output_dir</span><span class="p">,</span><span class="n">ridString</span><span class="p">,</span> <span class="s1">&#39;seasonal_params.json&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">adjust_w_for_plotting</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adjusts the w array based on the x conditions and returns an array with 14 elements.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        x (list): A list representing the conditions that influence the adjustment of w.</span>
<span class="sd">        w (array-like): An array of values to be adjusted based on x.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: A 14-element array with adjusted values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize the output array with 14 elements set to zero</span>
    <span class="n">w_s_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>

    <span class="c1"># Ensure icromo is 7 elements long</span>
    <span class="n">icromo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">icromo</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">:</span>
        <span class="c1"># Fill the rest with zeros</span>
        <span class="n">icromo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">icromo</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">icromo</span><span class="p">)))</span>

    <span class="c1"># Always present terms (mu, psi, xi)</span>
    <span class="n">w_s_plot</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
    
    <span class="c1"># Initialize the index for the input w</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="c1"># Assign terms based on icromo conditions</span>
    <span class="k">if</span> <span class="n">icromo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># annual</span>
        <span class="n">w_s_plot</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">2</span>
        
    <span class="k">if</span> <span class="n">icromo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># semiannual</span>
        <span class="n">w_s_plot</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">icromo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#triannual</span>
        <span class="n">w_s_plot</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">icromo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># long-term trend</span>
        <span class="n">w_s_plot</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">icromo</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># covariate, location</span>
        <span class="n">w_s_plot</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">icromo</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#covariate, scale</span>
        <span class="n">w_s_plot</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">icromo</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#nodal</span>
        <span class="n">w_s_plot</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">2</span>

    <span class="c1"># Return the adjusted array with 14 elements</span>
    <span class="k">return</span> <span class="n">w_s_plot</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_s_plot</span> <span class="o">=</span> <span class="n">adjust_w_for_plotting</span><span class="p">(</span><span class="n">x_s</span><span class="p">,</span><span class="n">w_s</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="extract-a-timeseries-of-the-time-dependent-return-values">
<h3>Extract a timeseries of the time-dependent return values<a class="headerlink" href="#extract-a-timeseries-of-the-time-dependent-return-values" title="Permalink to this heading">#</a></h3>
<p>For each time in a timeseries, we’ll evaluate the CDF of the time-dependent GEV at a given return period to get the expected return level. This first function evaluates the extreme value prediction over time for a given return period.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">Quantilentime</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t00</span><span class="p">,</span> <span class="n">t11</span><span class="p">,</span> <span class="n">return_period</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">serieCV</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Python equivalent of the Menendez MATLAB Quantilentime function.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    x0 : float</span>
<span class="sd">        The variable to find the root of.</span>
<span class="sd">    w : np.ndarray</span>
<span class="sd">        The current estimates of the parameters.</span>
<span class="sd">    x : np.ndarray</span>
<span class="sd">        Binary switches that indicate which parameters are active.</span>
<span class="sd">    t00 : float</span>
<span class="sd">        Start time.</span>
<span class="sd">    t11 : float</span>
<span class="sd">        End time.</span>
<span class="sd">    return_period : float</span>
<span class="sd">        Return period.</span>
<span class="sd">    ti : np.ndarray</span>
<span class="sd">        Time vector for climate index interpolation.</span>
<span class="sd">    serieCV : np.ndarray</span>
<span class="sd">        Climate index data to be interpolated.</span>

<span class="sd">    Returns:</span>
<span class="sd">    float</span>
<span class="sd">        The value of the function at x_value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ww = adjust_w_for_plotting(x, w)</span>
    <span class="c1"># Parameter unpacking</span>
    <span class="n">b0</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">b4</span><span class="p">,</span> <span class="n">b5</span><span class="p">,</span> <span class="n">b6</span> <span class="o">=</span> <span class="n">w</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span> <span class="c1"># basics + seasonal cycle</span>
    <span class="n">bLT</span><span class="p">,</span> <span class="n">bCI</span><span class="p">,</span> <span class="n">aCI</span><span class="p">,</span> <span class="n">bN1</span><span class="p">,</span> <span class="n">bN2</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span>  <span class="c1"># Initialize optional parameters</span>

    <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">ti</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t00</span><span class="p">,</span> <span class="n">t11</span> <span class="o">+</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

    <span class="c1"># Interpolate serieCV at ti points</span>
    <span class="n">serieCV2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">serieCV</span><span class="p">)</span>
    <span class="c1"># Replace NaNs with zero (np.interp does this by default if outside the bounds)</span>
    <span class="n">serieCV2</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">serieCV2</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">km</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="c1"># Define mut and other parameters</span>

    <span class="c1"># location(t)</span>
    <span class="n">mut</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">bLT</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">+</span>
           <span class="n">b1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">+</span> <span class="n">b2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">+</span>
           <span class="n">b3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">+</span> <span class="n">b4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">+</span>
           <span class="n">b5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">+</span> <span class="n">b6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">+</span>
           <span class="n">bN1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">18.61</span><span class="p">)</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">+</span> <span class="n">bN2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">18.61</span><span class="p">)</span> <span class="o">*</span> <span class="n">ti</span><span class="p">)</span> <span class="o">+</span>
           <span class="p">(</span><span class="n">bCI</span> <span class="o">*</span> <span class="n">serieCV2</span><span class="p">))</span>
    
    <span class="c1"># scale(t)</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">+</span> <span class="p">(</span><span class="n">aCI</span> <span class="o">*</span> <span class="n">serieCV2</span><span class="p">)</span>

    <span class="c1"># shape(t)</span>
    <span class="n">xit</span> <span class="o">=</span> <span class="n">xi</span>

    <span class="n">factor</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ti</span><span class="p">)):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">xit</span> <span class="o">*</span> <span class="p">(</span><span class="n">x0</span> <span class="o">-</span> <span class="n">mut</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">psi</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="mf">0.0001</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">xit</span><span class="p">)</span>
        <span class="n">factor</span> <span class="o">+=</span> <span class="n">h</span>

    <span class="n">prob</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">return_period</span><span class="p">)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">prob</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">km</span> <span class="o">*</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">y</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-confidence-intervals">
<h3>Calculate Confidence Intervals<a class="headerlink" href="#calculate-confidence-intervals" title="Permalink to this heading">#</a></h3>
<p>These next codes will calculate the derivative of the previous prediction, using the perturbation method. We will get be getting the derivative for each parameter, with the goal of solving the total variance:</p>
<div class="amsmath math notranslate nohighlight" id="equation-fd710ec6-dd0e-44a9-b93e-6077dfcaf044">
<span class="eqno">(7)<a class="headerlink" href="#equation-fd710ec6-dd0e-44a9-b93e-6077dfcaf044" title="Permalink to this equation">#</a></span>\[\begin{align}
\sigma^2_{L(\theta| t_i)} = \sum_{i=1}^{m}\sum_{i=1}^m \frac{\delta L}{\delta \theta_i}\frac{\delta L}{\delta \theta_j}[J_\theta]_{i,j},
\end{align}\]</div>
<p>where <span class="math notranslate nohighlight">\(L\)</span> likelihood function of the PDF of equation 1, and <span class="math notranslate nohighlight">\(J\)</span> is the inverse of the <span class="math notranslate nohighlight">\(m\)</span> x <span class="math notranslate nohighlight">\(m\)</span> covariance-variance matrix of the parameter estimates in <span class="math notranslate nohighlight">\(L\)</span>. Note that because this is an estimate at a given time, we will need to calculate this for all timesteps. Thus, we’ll define a function so that we can run this for each timestep.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">derivative_first_order</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t00</span><span class="p">,</span> <span class="n">t11</span><span class="p">,</span> <span class="n">return_period</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">covariate</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mf">0.0001</span>  <span class="c1"># Small perturbation</span>
    <span class="n">x0_initial</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Initial value for the root-finding function</span>

    <span class="n">wbest</span> <span class="o">=</span> <span class="n">adjust_w_for_plotting</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="c1"># Step 1: Calculate the baseline value with the current parameters</span>
    <span class="n">baseline_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x0</span><span class="p">:</span> <span class="n">Quantilentime</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">wbest</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t00</span><span class="p">,</span> <span class="n">t11</span><span class="p">,</span> <span class="n">return_period</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">covariate</span><span class="p">)</span>
    <span class="n">baseline_value</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span><span class="n">baseline_func</span><span class="p">,</span> <span class="n">x0_initial</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0_initial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Perturb the k-th parameter</span>
    <span class="n">perturbed_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="n">perturbed_w</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">h</span>
    <span class="n">wbest_perturbed</span> <span class="o">=</span> <span class="n">adjust_w_for_plotting</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">perturbed_w</span><span class="p">)</span>

    <span class="c1"># Step 2: Calculate the function value with the perturbed parameter</span>
    <span class="n">perturbed_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x0</span><span class="p">:</span> <span class="n">Quantilentime</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">wbest_perturbed</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t00</span><span class="p">,</span> <span class="n">t11</span><span class="p">,</span> <span class="n">return_period</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">covariate</span><span class="p">)</span>
    <span class="n">perturbed_value</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span><span class="n">perturbed_func</span><span class="p">,</span> <span class="n">x0_initial</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0_initial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Step 3: Numerical derivative</span>
    <span class="n">derivative</span> <span class="o">=</span> <span class="p">(</span><span class="n">perturbed_value</span> <span class="o">-</span> <span class="n">baseline_value</span><span class="p">)</span> <span class="o">/</span> <span class="n">h</span>
    
    <span class="k">return</span> <span class="n">derivative</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we have the derivative function, we will use this to craft our variance, for each timestep. For each (i,j) pair (the ith and jth parameters in w), we will multiply these derivates by the inverse of the covariance matrix, and finally sum over all (i,j) pairs. The square root of this is our standard deviation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calculate_std</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t00</span><span class="p">,</span><span class="n">t11</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span><span class="n">serieCV</span><span class="p">,</span> <span class="n">mio</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    
    <span class="c1"># only consider the first 3 elements of mio</span>
    <span class="c1"># n = 1</span>
    <span class="c1"># mio = mio[[0,9], [0,9]]</span>
    <span class="c1"># print(&#39;mio:&#39;, mio)</span>
    <span class="c1"># print(&#39;w:&#39;,w)</span>
    <span class="n">J_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mio</span><span class="p">)</span>
    <span class="n">ic</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="c1"># print(&#39;n:&#39;, n)</span>
    <span class="c1"># n = 9</span>
    <span class="n">Zp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">Zp1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">derivative_first_order</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t00</span><span class="p">,</span> <span class="n">t11</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">serieCV</span><span class="p">)</span>
    <span class="c1"># Zp1 = Zp1[1:]</span>
    <span class="c1"># print(&#39;w:&#39;, w)</span>
    <span class="c1"># print(&#39;Zp1:&#39;, Zp1)</span>
    <span class="n">Zbest</span> <span class="o">=</span> <span class="n">adjust_w_for_plotting</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Zp1</span><span class="p">)</span>
    <span class="c1"># Zbest[12:] = [0,0] #nodal</span>
    <span class="n">Zbest</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Zbest</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span> <span class="c1">#long-term trend (really depends what mio is, I am not sure if this is right!!)</span>
    <span class="n">wbest</span> <span class="o">=</span> <span class="n">adjust_w_for_plotting</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>

    <span class="c1"># remove elements of Zbest where wbest is zero (parameter not included)</span>
    <span class="n">Zbest</span> <span class="o">=</span> <span class="n">Zbest</span><span class="p">[</span><span class="n">wbest</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="c1">## is this correct? I think so...</span>

    <span class="n">Z_col</span> <span class="o">=</span> <span class="n">Zbest</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Zbest</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Multiply Z_col by its transpose ( should be a square matrix, nxn)</span>
    <span class="n">ZZ</span><span class="o">=</span> <span class="n">Z_col</span> <span class="o">@</span> <span class="n">Z_col</span><span class="o">.</span><span class="n">T</span>
    <span class="c1"># print(&#39;ZZ.shape:&#39;, ZZ.shape)</span>

    <span class="n">ic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ZZ</span> <span class="o">@</span> <span class="n">J_inv</span><span class="p">)</span>
    <span class="n">ic_sqrt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
    <span class="c1"># print(&#39;ic:&#39;, ic)</span>
    <span class="c1"># ww = adjust_w_for_plotting(x, w)</span>
    <span class="c1"># Yr_TG = brentq(Quantilentime, ww[1] - 2, ww[1] + 2, args=(ww, x, t00, t11, r, T, serieCV))</span>
    <span class="c1"># upper_confidence.append(Yr_TG + 1.96 * ic_sqrt)</span>
    <span class="c1"># lower_confidence.append(Yr_TG - 1.96 * ic_sqrt)</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ic_sqrt</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-the-time-dependent-return-value">
<h3>Calculate the Time Dependent Return Value<a class="headerlink" href="#calculate-the-time-dependent-return-value" title="Permalink to this heading">#</a></h3>
<p>With confidence intervals!</p>
<p>This code evaluates the likelihood function using the modeled parameters for a given set of years and return periods (in years). It will also return the 95% confidence intervals, with the assumption of Guassian distribution (<span class="math notranslate nohighlight">\(\pm 1.96 \sigma\)</span>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getTimeDependentReturnValue</span><span class="p">(</span><span class="n">T0</span><span class="p">,</span> <span class="n">serieCV</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ReturnPeriod</span><span class="p">):</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">T0</span>
    <span class="n">serieCV</span> <span class="o">=</span> <span class="n">covariate</span>
    <span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">wbest</span> <span class="o">=</span> <span class="n">adjust_w_for_plotting</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">YR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ReturnPeriod</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">ic_sqrt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ReturnPeriod</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">upper_confidence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ReturnPeriod</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">lower_confidence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ReturnPeriod</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ReturnPeriod</span><span class="p">):</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># initial value of return value in the iteration</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">t00</span> <span class="o">=</span> <span class="n">years</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">t11</span> <span class="o">=</span> <span class="n">years</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Call the Quantilentime function for each year interval</span>
            <span class="n">YR</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span><span class="n">Quantilentime</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x0</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">wbest</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t00</span><span class="p">,</span> <span class="n">t11</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">serieCV</span><span class="p">))</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">YR</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="c1"># print(&#39;calculating return value for year interval:&#39;, t00, t11)  </span>
            <span class="c1"># Calculate the confidence intervals</span>
            <span class="n">ic_sqrt</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_std</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t00</span><span class="p">,</span><span class="n">t11</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span><span class="n">serieCV</span><span class="p">,</span> <span class="n">mio</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="c1"># print(&#39;ic_sqrt:&#39;, ic_sqrt[idx,i])</span>
            <span class="n">upper_confidence</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">YR</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">ic_sqrt</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">lower_confidence</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">YR</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">ic_sqrt</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">years</span><span class="p">,</span> <span class="n">YR</span><span class="p">,</span> <span class="n">upper_confidence</span><span class="p">,</span> <span class="n">lower_confidence</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-monthly-extremes-and-given-year-return-period-with-the-seasonal-model">
<h3>Plot monthly extremes and given year return period with the seasonal model<a class="headerlink" href="#plot-monthly-extremes-and-given-year-return-period-with-the-seasonal-model" title="Permalink to this heading">#</a></h3>
<aside class="margin sidebar">
<p class="sidebar-title"></p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Note that the original code for this plot has the dotted line much lower - the 2 year return, for example, runs through the middle of the data. This corresponds to a 2-month return level, and makes sense if you are looking at each month in isolation (every other year the value is exceeded). This is the case in Méndez et al 2007 (and following papers), and likely comes down to an interpretation of what this line is actually meant to portray. Accounting for the fact that you are sampling monthly data moves the within-a-year return level up to more closely align with the ‘stationary’ solid line (and the sinusoid formed by the seasonal cycle then varies about the stationary return level). (Julia’s opinion here): because this plot is dimensionless (time goes from 0 to 1), we must normalize our data by removing the time component. In this case, the time element is the monthly sampling, so we must scale our probabilities accordingly by (1/12).</p>
</div>
</aside>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ReturnPeriod</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">]</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">mm</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">plottingExtremeSeasonality</span><span class="p">(</span><span class="n">mm</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">],</span><span class="n">mm</span><span class="p">[</span><span class="s1">&#39;monthly_max&#39;</span><span class="p">],</span><span class="n">w_s_plot</span><span class="p">,</span><span class="n">ReturnPeriod</span><span class="o">=</span><span class="n">ReturnPeriod</span><span class="p">,</span><span class="n">SampleRate</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># sss.set_xlabel(&#39;Month in Year&#39;)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sea level extremes at &#39;</span> <span class="o">+</span> <span class="n">station_name</span><span class="p">)</span>

<span class="c1"># save the figure</span>
<span class="n">savename</span> <span class="o">=</span> <span class="s1">&#39;SeasonalExtremeVariations_&#39;</span><span class="o">+</span> <span class="n">ridString</span> <span class="o">+</span><span class="s1">&#39;.png&#39;</span>
<span class="n">savedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">savename</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;seasonal_extreme_variations&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<img alt="../../_images/7e5b178c879a2f1d9037d5e453e4f2ef24a38d24a3d68e4e08c71c11484cc85f.png" src="../../_images/7e5b178c879a2f1d9037d5e453e4f2ef24a38d24a3d68e4e08c71c11484cc85f.png" />
</div>
</details>
</div>
<figure class="align-default" id="seasonal-extreme-variations">
<img alt="../../_images/7e5b178c879a2f1d9037d5e453e4f2ef24a38d24a3d68e4e08c71c11484cc85f.png" src="../../_images/7e5b178c879a2f1d9037d5e453e4f2ef24a38d24a3d68e4e08c71c11484cc85f.png" />
<figcaption>
<p><span class="caption-number">Fig. 9 </span><span class="caption-text">A climatology of extreme sea levels at the <span class="pasted-text">Honolulu, Hawaii</span> tide gauge. Monthly maxima (+), determined from hourly sea level data, are shown from 1993-2023. The solid line corresponds to projected sea level return levels at 2,10,50 and 100 years, using this 30-year chunk of data. This line uses a nonstationary GEV to take the seasonal variations of sea level into account. The 2, 10, 50 and 100-year return levels are shown to vary throughout the year (dashed line), with the lowest extremes occuring in March, and highest extremes peaking in July. No long-term trend is used in this model, and the scale and location parameters are held constant.</span><a class="headerlink" href="#seasonal-extreme-variations" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="check-if-we-should-include-a-long-term-trend-mean-sea-level-rise-in-our-location-parameter">
<h3>Check if we should include a long-term trend (mean sea level rise) in our location parameter<a class="headerlink" href="#check-if-we-should-include-a-long-term-trend-mean-sea-level-rise-in-our-location-parameter" title="Permalink to this heading">#</a></h3>
<p>I mean, it’s probably statistically significant, but hey, we should test just in case. First, we’ll make a function to save our modeled return levels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">save_model_to_netcdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">covariate</span><span class="p">,</span><span class="n">mio</span><span class="p">,</span><span class="n">ReturnPeriod</span><span class="p">,</span><span class="n">modelName</span><span class="p">,</span><span class="n">ridString</span><span class="p">,</span><span class="n">savepath</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span><span class="n">year0</span><span class="p">):</span>

    <span class="n">years</span><span class="p">,</span> <span class="n">RL</span><span class="p">,</span> <span class="n">RL_high</span><span class="p">,</span> <span class="n">RL_low</span> <span class="o">=</span> <span class="n">getTimeDependentReturnValue</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">covariate</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span><span class="n">x</span><span class="p">,</span> <span class="n">ReturnPeriod</span><span class="p">)</span>
    
    <span class="c1"># save the time-dependent return values to a netcdf file</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">RL</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ReturnPeriod</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">years</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">year0</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ReturnPeriod&#39;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Year&#39;</span>

    <span class="n">df_low</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">RL_low</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ReturnPeriod</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">years</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">year0</span><span class="p">)</span>
    <span class="n">df_low</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ReturnPeriod&#39;</span>
    <span class="n">df_low</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Year&#39;</span>

    <span class="n">df_high</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">RL_high</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ReturnPeriod</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">years</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">year0</span><span class="p">)</span>
    <span class="n">df_high</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ReturnPeriod&#39;</span>
    <span class="n">df_high</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Year&#39;</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;ReturnLevel&#39;</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;ReturnPeriod&#39;</span><span class="p">,</span> <span class="s1">&#39;Year&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">),</span>
                     <span class="s1">&#39;RL_low&#39;</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;ReturnPeriod&#39;</span><span class="p">,</span> <span class="s1">&#39;Year&#39;</span><span class="p">],</span> <span class="n">df_low</span><span class="p">),</span>
                     <span class="s1">&#39;RL_high&#39;</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;ReturnPeriod&#39;</span><span class="p">,</span> <span class="s1">&#39;Year&#39;</span><span class="p">],</span> <span class="n">df_high</span><span class="p">)})</span>

    <span class="c1"># set attributes</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Time-dependent return values for the GEV model with seasonality, trend, covariate in location and scale, and nodal cycle in location. The x attribute is the binary array of parameters used in the model, where the first 3 elements are the seasonal parameters, the 4th element is the long-term trend, the 5th element is the covariate in location, the 6th element is the covariate in scale, and the 7th element is the nodal cycle.&#39;</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;station_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station_name</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;datum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;STND&#39;</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;model_parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adjust_w_for_plotting</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;model_standard_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">standard_error</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;record_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ridString</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modelName</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># make year a coordinate</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">Year</span><span class="o">=</span><span class="n">years</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">year0</span><span class="p">)</span>

    <span class="c1"># make ReturnPeriod a coordinate</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">ReturnPeriod</span><span class="o">=</span><span class="n">ReturnPeriod</span><span class="p">)</span>

    <span class="n">ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">savepath</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model saved to netcdf file at: &#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2</span>

<span class="n">x_T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x_s</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>  <span class="c1"># Long-term Trend</span>


<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_output_dir</span> <span class="o">/</span> <span class="n">ridString</span> <span class="o">/</span> <span class="s1">&#39;trend_params.json&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">runWithoutModel</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_output_dir</span> <span class="o">/</span> <span class="n">ridString</span> <span class="o">/</span> <span class="s1">&#39;trend_params.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">w_T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">])</span>
        <span class="n">mio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;mio&#39;</span><span class="p">])</span>
        <span class="n">standard_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;standard_error&#39;</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">f_T</span> <span class="o">=</span> <span class="n">fitness</span><span class="p">(</span><span class="n">x_T</span><span class="p">,</span> <span class="n">modelType</span><span class="o">=</span><span class="s1">&#39;GEV_S_T_Cv&#39;</span><span class="p">)</span>
    <span class="n">w_T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;best.txt&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">mio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;mio.txt&#39;</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Assess standard errors of the parameters</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">mio</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mio</span><span class="p">)</span>
        <span class="n">standard_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">J</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model did not finish! Setting standard errors to 0.&#39;</span><span class="p">)</span>
        <span class="n">standard_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">mio</span><span class="p">))</span>

<span class="c1"># stdError = getLocationError(x_T, t, t, covariate, w_T, mio)</span>
<span class="c1">### FIX THIS</span>

<span class="n">aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;limits.txt&#39;</span><span class="p">)</span>
<span class="c1"># check to see if within limits</span>
<span class="n">wT</span> <span class="o">=</span> <span class="n">w_T</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wT</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">wT</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">aux</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">wT</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">aux</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trend Run: Parameter #</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1"> is at the limit: </span><span class="si">{</span><span class="n">wT</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># check significance of adding the trend</span>
<span class="n">diffe</span> <span class="o">=</span> <span class="n">w_T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">w_s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">p</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">SignifTrend</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">diffe</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Statistical Significance of Linear Trend: </span><span class="si">{</span><span class="n">SignifTrend</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Estimated Trend on monthly Maxima values is: </span><span class="si">{</span><span class="n">w_T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">w_T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> mm/year&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;x_T is: </span><span class="si">{</span><span class="n">x_T</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;x_T is: </span><span class="si">{</span><span class="n">x_T</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;w_T is: </span><span class="si">{</span><span class="n">w_T</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="n">w_T</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s1">&#39;mio&#39;</span><span class="p">:</span> <span class="n">mio</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s1">&#39;standard_error&#39;</span><span class="p">:</span> <span class="n">standard_error</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x_T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
<span class="n">savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_output_dir</span><span class="p">,</span><span class="n">ridString</span><span class="p">,</span> <span class="s1">&#39;trend_params.json&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="n">savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_output_dir</span><span class="p">,</span><span class="n">ridString</span><span class="p">,</span> <span class="s1">&#39;RL_muT.nc&#39;</span><span class="p">)</span>
<span class="c1"># save_model_to_netcdf(x,w,t,covariate,standard_error,ReturnPeriod,modelName,ridString,savepath, station_name,year0):</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">savepath</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model already saved to netcdf file.&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">save_model_to_netcdf</span><span class="p">(</span><span class="n">x_T</span><span class="p">,</span><span class="n">w_T</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">covariate</span><span class="o">=</span><span class="n">covariate</span><span class="p">,</span><span class="n">standard_error</span> <span class="o">=</span> <span class="n">standard_error</span><span class="p">,</span><span class="n">ReturnPeriod</span><span class="o">=</span><span class="n">ReturnPeriod</span><span class="p">,</span><span class="n">modelName</span><span class="o">=</span><span class="s1">&#39;Model_GEV_S_T_Cv.exe&#39;</span><span class="p">,</span><span class="n">ridString</span><span class="o">=</span><span class="n">ridString</span><span class="p">,</span><span class="n">savepath</span><span class="o">=</span><span class="n">savepath</span><span class="p">,</span> <span class="n">station_name</span><span class="o">=</span><span class="n">station_name</span><span class="p">,</span><span class="n">year0</span><span class="o">=</span><span class="n">year0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Statistical Significance of Linear Trend: 100.00%
Estimated Trend on monthly Maxima values is: 2.97 mm/year
x_T is: [1 1 0 1 0 0]
x_T is: [1 1 0 1 0 0]
w_T is: [ 4.67039758e+02  1.85962112e+00  6.66646400e-02 -2.22472000e-01
 -4.22099000e-03 -4.67291700e-02  5.26789800e-02 -6.08231000e-03
  1.59690000e-03]
Model already saved to netcdf file.
</pre></div>
</div>
</div>
</div>
<section id="check-the-covariate-in-the-location-parameter">
<h4>Check the covariate in the location parameter.<a class="headerlink" href="#check-the-covariate-in-the-location-parameter" title="Permalink to this heading">#</a></h4>
<p>Let’s check if the covariate inclusion in the location parameter is statistically significant.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">SignifTrend</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">:</span>
    <span class="n">x_cvte1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x_s</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>  <span class="c1"># Covariate</span>
    <span class="n">wcomp</span> <span class="o">=</span> <span class="n">w_T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">x_cvte1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x_s</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
    <span class="n">wcomp</span> <span class="o">=</span> <span class="n">w_s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_output_dir</span> <span class="o">/</span> <span class="n">ridString</span> <span class="o">/</span> <span class="s1">&#39;cvte_location_params.json&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">runWithoutModel</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_output_dir</span> <span class="o">/</span> <span class="n">ridString</span> <span class="o">/</span> <span class="s1">&#39;cvte_location_params.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">w_cvte1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">])</span>
        <span class="n">mio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;mio&#39;</span><span class="p">])</span>
        <span class="n">standard_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;standard_error&#39;</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">f_cvte1</span> <span class="o">=</span> <span class="n">fitness</span><span class="p">(</span><span class="n">x_cvte1</span><span class="p">,</span> <span class="n">modelType</span><span class="o">=</span><span class="s1">&#39;GEV_S_T_Cv&#39;</span><span class="p">)</span>
    <span class="n">w_cvte1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;best.txt&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">mio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;mio.txt&#39;</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Assess standard errors of the parameters</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">mio</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mio</span><span class="p">)</span>
        <span class="n">standard_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">J</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model did not finish! Setting standard errors to 0.&#39;</span><span class="p">)</span>
        <span class="n">standard_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">mio</span><span class="p">))</span>

<span class="n">diffe</span> <span class="o">=</span> <span class="n">w_cvte1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wcomp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">p</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">SignifCvte1</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">diffe</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Statistical Significance of Covariate in location param.: </span><span class="si">{</span><span class="n">SignifCvte1</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;x_cvte1 is: </span><span class="si">{</span><span class="n">x_cvte1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="n">w_cvte1</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s1">&#39;mio&#39;</span><span class="p">:</span> <span class="n">mio</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s1">&#39;standard_error&#39;</span><span class="p">:</span> <span class="n">standard_error</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x_cvte1</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
<span class="n">savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_output_dir</span><span class="p">,</span><span class="n">ridString</span><span class="p">,</span> <span class="s1">&#39;cvte_location_params.json&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="n">savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_output_dir</span><span class="p">,</span><span class="n">ridString</span><span class="p">,</span> <span class="s1">&#39;RL_muT_cv1.nc&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">savepath</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model already saved to netcdf file.&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">save_model_to_netcdf</span><span class="p">(</span><span class="n">x_cvte1</span><span class="p">,</span><span class="n">w_cvte1</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">covariate</span><span class="p">,</span><span class="n">standard_error</span> <span class="o">=</span> <span class="n">standard_error</span><span class="p">,</span><span class="n">ReturnPeriod</span><span class="o">=</span><span class="n">ReturnPeriod</span><span class="p">,</span><span class="n">modelName</span><span class="o">=</span><span class="s1">&#39;Model_GEV_S_T_Cv.exe&#39;</span><span class="p">,</span><span class="n">ridString</span><span class="o">=</span><span class="n">ridString</span><span class="p">,</span><span class="n">savepath</span><span class="o">=</span><span class="n">savepath</span><span class="p">,</span> <span class="n">station_name</span><span class="o">=</span><span class="n">station_name</span><span class="p">,</span><span class="n">year0</span><span class="o">=</span><span class="n">year0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model did not finish! Setting standard errors to 0.
Statistical Significance of Covariate in location param.: 54.60%
x_cvte1 is: [1 1 0 1 1 0]
Model already saved to netcdf file.
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="check-the-covariate-in-scale-parameter">
<h3>Check the covariate in scale parameter<a class="headerlink" href="#check-the-covariate-in-scale-parameter" title="Permalink to this heading">#</a></h3>
<p>Let’s check if the covariate inclusion in the scale parameter is statistically significant.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">SignifCvte1</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">:</span>
    <span class="n">x_cvte2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x_cvte1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># Covariate</span>
    <span class="n">wcomp</span> <span class="o">=</span> <span class="n">w_cvte1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">x_cvte2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x_cvte1</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>  <span class="c1"># Covariate</span>
    <span class="n">wcomp</span> <span class="o">=</span> <span class="n">wcomp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_output_dir</span> <span class="o">/</span> <span class="n">ridString</span> <span class="o">/</span> <span class="s1">&#39;cvte_scale_params.json&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">runWithoutModel</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_output_dir</span> <span class="o">/</span> <span class="n">ridString</span> <span class="o">/</span> <span class="s1">&#39;cvte_scale_params.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">w_cvte2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">])</span>
        <span class="n">mio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;mio&#39;</span><span class="p">])</span>
        <span class="n">standard_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;standard_error&#39;</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">f_cvte2</span> <span class="o">=</span> <span class="n">fitness</span><span class="p">(</span><span class="n">x_cvte2</span><span class="p">,</span> <span class="n">modelType</span><span class="o">=</span><span class="s1">&#39;GEV_S_T_Cv&#39;</span><span class="p">)</span>
    <span class="n">w_cvte2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;best.txt&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">mio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;mio.txt&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Assess standard errors of the parameters</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">mio</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mio</span><span class="p">)</span>
        <span class="n">standard_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">J</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model did not finish! Setting standard errors to 0.&#39;</span><span class="p">)</span>
        <span class="n">standard_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">mio</span><span class="p">))</span>

<span class="n">diffe</span> <span class="o">=</span> <span class="n">w_cvte2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wcomp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">p</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">SignifCvte2</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">diffe</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Statistical Significance of Covariate in scale param.: </span><span class="si">{</span><span class="n">SignifCvte2</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;x_cvte2 is: </span><span class="si">{</span><span class="n">x_cvte2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="n">w_cvte2</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s1">&#39;mio&#39;</span><span class="p">:</span> <span class="n">mio</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s1">&#39;standard_error&#39;</span><span class="p">:</span> <span class="n">standard_error</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x_cvte2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
<span class="n">savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_output_dir</span><span class="p">,</span><span class="n">ridString</span><span class="p">,</span> <span class="s1">&#39;cvte_scale_params.json&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="n">savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_output_dir</span><span class="p">,</span><span class="n">ridString</span><span class="p">,</span> <span class="s1">&#39;RL_muT_cv2.nc&#39;</span><span class="p">)</span>

<span class="c1"># If savepath is not None, save the model to a netcdf file</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">savepath</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model already saved to netcdf file.&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">save_model_to_netcdf</span><span class="p">(</span><span class="n">x_cvte2</span><span class="p">,</span><span class="n">w_cvte2</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">covariate</span><span class="p">,</span><span class="n">standard_error</span><span class="p">,</span><span class="n">ReturnPeriod</span><span class="p">,</span><span class="n">modelName</span><span class="o">=</span><span class="s1">&#39;Model_GEV_S_T_Cv.exe&#39;</span><span class="p">,</span><span class="n">ridString</span><span class="o">=</span><span class="n">ridString</span><span class="p">,</span><span class="n">savepath</span><span class="o">=</span><span class="n">savepath</span><span class="p">,</span> <span class="n">station_name</span><span class="o">=</span><span class="n">station_name</span><span class="p">,</span><span class="n">year0</span><span class="o">=</span><span class="n">year0</span><span class="p">)</span>   
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model did not finish! Setting standard errors to 0.
Statistical Significance of Covariate in scale param.: 40.86%
x_cvte2 is: [1 1 0 1 0 1]
Model already saved to netcdf file.
</pre></div>
</div>
</div>
</div>
</section>
<section id="check-the-nodal-cycle-in-location-parameter">
<h3>Check the nodal cycle in Location parameter<a class="headerlink" href="#check-the-nodal-cycle-in-location-parameter" title="Permalink to this heading">#</a></h3>
<p>We will only include the nodal cycle in our final model if adding it significantly improves our model thus far. We will add it to the long-term trend model if the long-term trend is significant.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">SignifCvte2</span><span class="o">&gt;</span><span class="mf">0.95</span><span class="p">:</span>
    <span class="c1"># x_N=np.append(x_T , [1])</span>
    <span class="n">x_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_cvte2</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">wcomp</span><span class="o">=</span><span class="n">w_cvte2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The trend is significant! </span><span class="se">\n</span><span class="s1">Include long-term trend and nodal cycle in final model.&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># x_N=np.append(x_s,[0, 0, 0, 1])</span>
    <span class="n">x_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_cvte2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">wcomp</span><span class="o">=</span><span class="n">wcomp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Check if the results are already saved</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_output_dir</span> <span class="o">/</span> <span class="n">ridString</span> <span class="o">/</span> <span class="s1">&#39;nodal_params.json&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">runWithoutModel</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_output_dir</span> <span class="o">/</span> <span class="n">ridString</span> <span class="o">/</span> <span class="s1">&#39;nodal_params.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">w_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">])</span>
        <span class="n">mioN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;mio&#39;</span><span class="p">])</span>
        <span class="n">standard_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;standard_error&#39;</span><span class="p">])</span>
        <span class="n">x_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running Nodal cycle model...&#39;</span><span class="p">)</span>
    <span class="n">f_N</span> <span class="o">=</span> <span class="n">fitness</span><span class="p">(</span><span class="n">x_N</span><span class="p">,</span> <span class="n">modelType</span><span class="o">=</span><span class="s1">&#39;GEV_S_T_Cv_Nodal&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;x_N is: </span><span class="si">{</span><span class="n">x_N</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">w_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;best.txt&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">mio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;mio.txt&#39;</span><span class="p">)</span>
        <span class="c1"># Assess standard errors of the parameters</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">mio</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mio</span><span class="p">)</span>
        <span class="n">standard_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">J</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model did not finish! Setting standard errors to 0.&#39;</span><span class="p">)</span>
        <span class="n">standard_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">mio</span><span class="p">))</span>


<span class="n">wN</span> <span class="o">=</span> <span class="n">w_N</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wN</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">wN</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">aux</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">wN</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">aux</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Nodal Run: Parameter #</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1"> is at the limit: </span><span class="si">{</span><span class="n">wN</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    

<span class="n">diffe</span> <span class="o">=</span> <span class="n">w_N</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wcomp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">p</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">SignifN</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">diffe</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Statistical Significance of adding Nodal cycle: </span><span class="si">{</span><span class="n">SignifN</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">SignifN</span><span class="o">&lt;</span><span class="mf">0.95</span><span class="p">:</span>
    <span class="n">x_N</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># set the nodal component to zero</span>
    <span class="n">w_N</span> <span class="o">=</span> <span class="n">wcomp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># use the previous model</span>
    <span class="n">w_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w_N</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="c1"># add zeros for the nodal cycle</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Nodal cycle is not significant! </span><span class="se">\n</span><span class="s1">Use previous model without nodal cycle.</span><span class="se">\n</span><span class="s1"> New x_N is: &#39;</span><span class="p">,</span> <span class="n">x_N</span><span class="p">)</span>



<span class="c1"># save w_N, mioN, standard_error, x_N as json file</span>
<span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="n">w_N</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s1">&#39;mio&#39;</span><span class="p">:</span> <span class="n">mio</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s1">&#39;standard_error&#39;</span><span class="p">:</span> <span class="n">standard_error</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x_N</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
<span class="n">savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_output_dir</span><span class="p">,</span><span class="n">ridString</span><span class="p">,</span> <span class="s1">&#39;nodal_params.json&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="n">savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_output_dir</span><span class="p">,</span><span class="n">ridString</span><span class="p">,</span> <span class="s1">&#39;RL_muN.nc&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">savepath</span><span class="p">)</span> <span class="ow">and</span> <span class="n">runWithoutModel</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model exists: &#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">save_model_to_netcdf</span><span class="p">(</span><span class="n">x_N</span><span class="p">,</span><span class="n">w_N</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">covariate</span><span class="p">,</span><span class="n">standard_error</span><span class="p">,</span><span class="n">ReturnPeriod</span><span class="p">,</span><span class="n">modelName</span><span class="o">=</span><span class="s1">&#39;Model_GEV_S_T_Cv_N.exe&#39;</span><span class="p">,</span><span class="n">ridString</span><span class="o">=</span><span class="n">ridString</span><span class="p">,</span><span class="n">savepath</span><span class="o">=</span><span class="n">savepath</span><span class="p">,</span> <span class="n">station_name</span><span class="o">=</span><span class="n">station_name</span><span class="p">,</span><span class="n">year0</span><span class="o">=</span><span class="n">year0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Running Nodal cycle model...
x_N is: [1 1 0 1 0 0 1]
Statistical Significance of adding Nodal cycle: 99.88%
Model saved to netcdf file at:  ..\..\data\GEV_model_output\57\RL_muN.nc
</pre></div>
</div>
</div>
</div>
<p>Get a list of the parameter names that correspond to the ‘x_N’ variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Annual seasonal cycle&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Semiannual seasonal cycle&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Triannual seasonal cycle&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Long-term Trend in Location&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Covariate in Location&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Covariate in Scale&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Nodal Cycle&#39;</span><span class="p">]</span>

<span class="c1"># Write out the parameter names, where if x[i] = 1, the parameter is included, otherwise it is removed from the list</span>
<span class="n">parameters_included</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_N</span><span class="p">,</span> <span class="n">param_names</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>


<span class="c1"># Format the parameter names for display, where each parameter is separated by a comma and the last parameter is preceded by &#39;and&#39;</span>
<span class="n">parameters_included</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parameters_included</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;, and &#39;</span> <span class="o">+</span> <span class="n">parameters_included</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;parameters_included&quot;</span><span class="p">,</span> <span class="n">parameters_included</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Annual seasonal cycle, Semiannual seasonal cycle, Long-term Trend in Location, and Nodal Cycle&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="plot-the-timeseries">
<h2>Plot the timeseries<a class="headerlink" href="#plot-the-timeseries" title="Permalink to this heading">#</a></h2>
<p>We’ll first extract all the relevant return levels for various models.</p>
<aside class="margin sidebar">
<p class="sidebar-title"></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Still toying with this!</p>
</div>
</aside>
<section id="plot-it-up">
<h3>Plot it up<a class="headerlink" href="#plot-it-up" title="Permalink to this heading">#</a></h3>
<p>For now we’ll use only the nodal + long-term trend + seasonality model.</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_output_dir</span><span class="p">,</span><span class="n">ridString</span><span class="p">,</span> <span class="s1">&#39;RL_muN.nc&#39;</span><span class="p">))</span>
<span class="n">dsMHHW</span> <span class="o">=</span> <span class="n">ds</span> <span class="o">-</span> <span class="n">STNDtoMHHW</span>
<span class="n">dsMHHW</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;m, MHHW&#39;</span>

<span class="c1"># close the dataset</span>
<span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># get the first year of ds</span>
<span class="n">year0</span> <span class="o">=</span> <span class="n">dsMHHW</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;year0&quot;</span><span class="p">,</span> <span class="n">year0</span><span class="p">)</span>

<span class="n">year0plot</span> <span class="o">=</span> <span class="mi">1993</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">sss</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">yearseval</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2008</span><span class="p">,</span><span class="mi">2020</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dsMHHW</span><span class="p">[</span><span class="s1">&#39;ReturnPeriod&#39;</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dsMHHW</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">],</span> <span class="n">dsMHHW</span><span class="p">[</span><span class="s1">&#39;ReturnLevel&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rp</span><span class="o">.</span><span class="n">values</span><span class="si">}</span><span class="s1">y&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">yearseval</span><span class="p">:</span>
        <span class="n">yrval</span> <span class="o">=</span> <span class="n">dsMHHW</span><span class="p">[</span><span class="s1">&#39;ReturnLevel&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">Year</span><span class="o">=</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">dsMHHW</span><span class="p">[</span><span class="s1">&#39;RL_high&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">Year</span><span class="o">=</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">yrval</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">yrval</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">yrval</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> $\pm$ </span><span class="si">{</span><span class="n">std</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">  m&#39;</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">dsMHHW</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">],</span> <span class="n">dsMHHW</span><span class="p">[</span><span class="s1">&#39;RL_low&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">dsMHHW</span><span class="p">[</span><span class="s1">&#39;RL_high&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># add monthly maxima</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mm</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">year0</span><span class="p">,</span> <span class="n">mm</span><span class="p">[</span><span class="s1">&#39;monthly_max&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">STNDtoMHHW</span><span class="p">,</span> <span class="s1">&#39;+k&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Monthly maxima&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>    

<span class="c1"># add title of station name</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Nonstationary GEV Return Levels: &#39;</span> <span class="o">+</span> <span class="n">station_name</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sea level (m, MHHW)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Return Period&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># arrange yaxis for breathing room</span>
<span class="n">meanmaxSL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">mm</span><span class="p">[</span><span class="s1">&#39;monthly_max&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">STNDtoMHHW</span><span class="p">)</span>
<span class="n">rangemaxSL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">mm</span><span class="p">[</span><span class="s1">&#39;monthly_max&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">mm</span><span class="p">[</span><span class="s1">&#39;monthly_max&#39;</span><span class="p">])</span> <span class="c1"># Range</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="n">year0plot</span><span class="p">,</span> <span class="mi">2023</span><span class="p">,</span> <span class="n">meanmaxSL</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">rangemaxSL</span><span class="p">,</span> <span class="n">meanmaxSL</span><span class="o">+</span><span class="mf">0.75</span><span class="o">*</span><span class="n">rangemaxSL</span><span class="p">])</span>

<span class="c1"># save the figure</span>
<span class="n">savename</span> <span class="o">=</span> <span class="s1">&#39;TimeDependentReturnValue_&#39;</span><span class="o">+</span> <span class="n">ridString</span> <span class="o">+</span><span class="s1">&#39;.png&#39;</span>
<span class="n">savedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">savename</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

<span class="c1"># glue the figure</span>
<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;TimeDependentReturnValue&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1993.0
</pre></div>
</div>
<img alt="../../_images/9975db1de8b073482dab8850286b9f9547721768297376d779ab4c76721035f9.png" src="../../_images/9975db1de8b073482dab8850286b9f9547721768297376d779ab4c76721035f9.png" />
</div>
</details>
</div>
<figure class="align-default" id="timedependentreturnvalue">
<img alt="../../_images/9975db1de8b073482dab8850286b9f9547721768297376d779ab4c76721035f9.png" src="../../_images/9975db1de8b073482dab8850286b9f9547721768297376d779ab4c76721035f9.png" />
<figcaption>
<p><span class="caption-number">Fig. 10 </span><span class="caption-text">Time series of the nonstationary GEV-based extreme water level return values for <span class="pasted-text">Honolulu, Hawaii</span>. The monthly maxima (+) are displayed spanning data from <span class="pasted-text">1993.0</span> to 2023. The return levels (at 2, 10, 50, and 100 year levels) are shown in solid lines. The 95% Confidence Interval (shaded area) also varies in time, and is shown only for the 2 year return level (<strong>NEEDS CHECKING</strong>). Years 2008 and 2020 are highlighted on these curves to show the differences in values when taking seasonality, a long-term trend, and the 18.6 nodal-cycle into account. This particular best-fit model for <span class="pasted-text">Honolulu, Hawaii</span> includes the <span class="pasted-text">Annual seasonal cycle, Semiannual seasonal cycle, Long-term Trend in Location, and Nodal Cycle</span>.</span><a class="headerlink" href="#timedependentreturnvalue" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<aside class="margin sidebar">
<p class="sidebar-title"></p>
<p>Caution: Confidence Intervals still getting tweaked!!</p>
</aside>
</section>
</section>
<section id="create-a-combined-dataset-for-further-plotting-and-analysis">
<h2>Create a combined dataset for further plotting and analysis<a class="headerlink" href="#create-a-combined-dataset-for-further-plotting-and-analysis" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># One dataset to rule them all</span>

<span class="c1"># Find all RL_muN.nc files</span>
<span class="n">file_pattern</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_output_dir</span> <span class="o">/</span> <span class="s1">&#39;**/RL_muN.nc&#39;</span><span class="p">)</span>
<span class="n">file_paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file_pattern</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Initialize an empty list to hold each dataset</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    
    <span class="c1"># Extract important attributes</span>
    <span class="n">record_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;record_id&#39;</span><span class="p">))</span>    
    <span class="n">station_name</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;station_name&#39;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>  <span class="c1"># Assuming x is stored as an attribute and has varying lengths</span>
    
    <span class="c1"># Ensure &#39;year&#39; and &#39;return_level&#39; are coordinates and are preserved</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;year&#39;</span> <span class="ow">in</span> <span class="n">ds</span> <span class="k">else</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>
    <span class="n">return_level</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;return_level&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;return_level&#39;</span> <span class="ow">in</span> <span class="n">ds</span> <span class="k">else</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;return_level&#39;</span><span class="p">)</span>
    
    <span class="c1"># Expand the dataset with the &#39;station&#39; dimension (coordinate)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">({</span><span class="s1">&#39;record_id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">record_id</span><span class="p">]})</span>
    
    <span class="c1"># Store x as a variable with its own dimension (e.g., &#39;x_dim&#39;)</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x_dim&#39;</span><span class="p">])</span>
    
    <span class="c1"># Keep station_name as an attribute of the dataset</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;station_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station_name</span>
    
    <span class="c1"># Add the dataset to the list</span>
    <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

<span class="c1"># Combine all datasets along the &#39;station&#39; dimension</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;record_id&#39;</span><span class="p">,</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="s1">&#39;override&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Combined dataset created successfully.&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred during dataset concatenation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># remove attributes that are not needed</span>
<span class="n">attributes_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;station_name&#39;</span><span class="p">,</span> <span class="s1">&#39;model_parameters&#39;</span><span class="p">,</span> <span class="s1">&#39;model_standard_error&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;record_id&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attributes_to_remove</span><span class="p">:</span>
    <span class="n">combined_ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Combined dataset created successfully.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add lat, lon, and station_name to the dataset from rsl_hourly</span>
<span class="n">rids</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="p">[</span><span class="s1">&#39;record_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">lats</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">lons</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">MHHW</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">rids</span><span class="p">:</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">rsl_hourly</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">record_id</span><span class="o">=</span><span class="n">rid</span><span class="p">)[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">rsl_hourly</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">record_id</span><span class="o">=</span><span class="n">rid</span><span class="p">)[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">mhhw</span> <span class="o">=</span> <span class="mf">0.001</span><span class="o">*</span><span class="n">rsl_hourly</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">record_id</span><span class="o">=</span><span class="n">rid</span><span class="p">)[</span><span class="s1">&#39;MHHW&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">lats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
    <span class="n">lons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
    <span class="n">MHHW</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mhhw</span><span class="p">)</span>

<span class="n">combined_ds</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">lats</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s1">&#39;record_id&#39;</span><span class="p">)</span>
<span class="n">combined_ds</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s1">&#39;record_id&#39;</span><span class="p">)</span>
<span class="n">combined_ds</span><span class="p">[</span><span class="s1">&#39;MHHW&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">MHHW</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s1">&#39;record_id&#39;</span><span class="p">)</span>

<span class="c1"># add station_name</span>
<span class="n">station_names</span> <span class="o">=</span> <span class="n">rsl_hourly</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">record_id</span><span class="o">=</span><span class="n">rids</span><span class="p">)[</span><span class="s1">&#39;station_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">combined_ds</span><span class="p">[</span><span class="s1">&#39;station_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">station_names</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s1">&#39;record_id&#39;</span><span class="p">)</span>

<span class="c1"># save the combined dataset to a netcdf file</span>
<span class="c1"># combined_ds.to_netcdf(output_dir / &#39;combined_return_levels.nc&#39;)</span>
<span class="n">combined_ds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.Dataset&gt; Size: 25kB
Dimensions:       (record_id: 8, ReturnPeriod: 4, Year: 31, x_dim: 7)
Coordinates:
  * record_id     (record_id) int64 64B 50 52 552 57 58 59 60 61
  * Year          (Year) float64 248B 1.993e+03 1.994e+03 ... 2.023e+03
  * ReturnPeriod  (ReturnPeriod) int64 32B 2 10 50 100
Dimensions without coordinates: x_dim
Data variables:
    ReturnLevel   (record_id, ReturnPeriod, Year) float64 8kB 1.609 ... 2.062
    RL_low        (record_id, ReturnPeriod, Year) float64 8kB 1.53 ... 1.959
    RL_high       (record_id, ReturnPeriod, Year) float64 8kB 1.687 ... 2.165
    x             (record_id, x_dim) int64 448B 1 1 0 1 0 1 0 ... 1 1 0 1 0 0 1
    lat           (record_id) float32 32B 28.22 16.75 20.03 ... 20.9 19.73 21.43
    lon           (record_id) float32 32B 182.6 190.5 204.2 ... 204.9 202.2
    MHHW          (record_id) float64 64B 1.204 1.225 1.406 ... 1.912 1.533
    station_name  (record_id) &lt;U17 544B &#x27;Midway&#x27; &#x27;Johnston&#x27; ... &#x27;Mokuoloe&#x27;
Attributes:
    description:  Time-dependent return values for the GEV model with seasona...
    datum:        STND
    units:        m</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.Dataset</div></div><ul class='xr-sections'><li class='xr-section-item'><input id='section-af64bcc8-6fed-4bff-bd10-d9974e99d0b3' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-af64bcc8-6fed-4bff-bd10-d9974e99d0b3' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label><div class='xr-section-inline-details'><ul class='xr-dim-list'><li><span class='xr-has-index'>record_id</span>: 8</li><li><span class='xr-has-index'>ReturnPeriod</span>: 4</li><li><span class='xr-has-index'>Year</span>: 31</li><li><span>x_dim</span>: 7</li></ul></div><div class='xr-section-details'></div></li><li class='xr-section-item'><input id='section-979bcabe-997a-48b0-9039-6e39c4ba297a' class='xr-section-summary-in' type='checkbox'  checked><label for='section-979bcabe-997a-48b0-9039-6e39c4ba297a' class='xr-section-summary' >Coordinates: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>record_id</span></div><div class='xr-var-dims'>(record_id)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>50 52 552 57 58 59 60 61</div><input id='attrs-5b198b3f-9fea-4d8c-be3f-3289e71cb1ab' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-5b198b3f-9fea-4d8c-be3f-3289e71cb1ab' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-8e703a19-d92e-4daa-83fe-98be776f0483' class='xr-var-data-in' type='checkbox'><label for='data-8e703a19-d92e-4daa-83fe-98be776f0483' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([ 50,  52, 552,  57,  58,  59,  60,  61])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>Year</span></div><div class='xr-var-dims'>(Year)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>1.993e+03 1.994e+03 ... 2.023e+03</div><input id='attrs-2f002329-3dce-4294-b31a-c75afa5ed12f' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-2f002329-3dce-4294-b31a-c75afa5ed12f' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-5f84b2c2-5272-40d2-9b56-5b5fc3dd7b8c' class='xr-var-data-in' type='checkbox'><label for='data-5f84b2c2-5272-40d2-9b56-5b5fc3dd7b8c' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([1993., 1994., 1995., 1996., 1997., 1998., 1999., 2000., 2001., 2002.,
       2003., 2004., 2005., 2006., 2007., 2008., 2009., 2010., 2011., 2012.,
       2013., 2014., 2015., 2016., 2017., 2018., 2019., 2020., 2021., 2022.,
       2023.])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>ReturnPeriod</span></div><div class='xr-var-dims'>(ReturnPeriod)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>2 10 50 100</div><input id='attrs-7cdf904b-4fda-4ee3-a335-9528052d7c90' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-7cdf904b-4fda-4ee3-a335-9528052d7c90' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-97876cda-5dfa-48d5-aed0-b3601abc941c' class='xr-var-data-in' type='checkbox'><label for='data-97876cda-5dfa-48d5-aed0-b3601abc941c' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([  2,  10,  50, 100])</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-7f5b2ba7-cf50-4f09-a5eb-25601b5d52d3' class='xr-section-summary-in' type='checkbox'  checked><label for='section-7f5b2ba7-cf50-4f09-a5eb-25601b5d52d3' class='xr-section-summary' >Data variables: <span>(8)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>ReturnLevel</span></div><div class='xr-var-dims'>(record_id, ReturnPeriod, Year)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>1.609 1.616 1.608 ... 2.062 2.062</div><input id='attrs-2a59b8b1-bc95-49b0-a309-f4d6030593ad' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-2a59b8b1-bc95-49b0-a309-f4d6030593ad' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-c2ffec5a-ca58-47a6-80da-a08441911103' class='xr-var-data-in' type='checkbox'><label for='data-c2ffec5a-ca58-47a6-80da-a08441911103' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[[1.60863699, 1.6164796 , 1.60819215, 1.60250053, 1.63817341,
         1.62372674, 1.5968824 , 1.60742884, 1.62159594, 1.64261855,
         1.64337426, 1.64810082, 1.64209168, 1.64594998, 1.63799074,
         1.63341748, 1.6611676 , 1.65371707, 1.64144892, 1.65920982,
         1.66185377, 1.67298777, 1.70508639, 1.69000438, 1.67402457,
         1.68434789, 1.69921924, 1.68531464, 1.67824819, 1.6801307 ,
         1.71711954],
        [1.75893306, 1.77083993, 1.75769288, 1.74224171, 1.80258119,
         1.78476635, 1.72637454, 1.74193967, 1.76381352, 1.79690893,
         1.79793964, 1.80219363, 1.79109389, 1.79519081, 1.78267902,
         1.76816088, 1.81500545, 1.80704927, 1.77458265, 1.80208327,
         1.80537609, 1.82199544, 1.87430184, 1.85341469, 1.81593549,
         1.83298329, 1.85505646, 1.83161195, 1.81420091, 1.81633048,
         1.87705349],
        [1.87941691, 1.89508115, 1.87965784, 1.85427129, 1.93757487,
         1.92066266, 1.83013878, 1.84989323, 1.87784605, 1.92109237,
         1.92250803, 1.92593648, 1.91164039, 1.91618147, 1.90145173,
         1.87654489, 1.94062864, 1.93532074, 1.88123394, 1.91669333,
         1.92053123, 1.9419794 , 2.0118368 , 1.98925898, 1.92975366,
         1.95358568, 1.98034189, 1.95070135, 1.92310149, 1.92572532,
...
         1.92299997, 1.93152463, 1.93948872, 1.94649667, 1.95188766,
         1.95531356, 1.95664562, 1.95598776, 1.95366546, 1.95019105,
         1.94632195, 1.94253789, 1.93963982, 1.93821849, 1.93869856,
         1.941288  , 1.94595295, 1.95242172, 1.9602173 , 1.96871388,
         1.97720985, 1.98500803, 1.99149373, 1.99620197, 1.99886741,
         1.99945216],
        [1.9424434 , 1.94417151, 1.94802045, 1.95392822, 1.96124137,
         1.96950008, 1.97802027, 1.98596861, 1.99294617, 1.99830137,
         2.00169231, 2.00299526, 2.00231696, 1.99998327, 1.99650533,
         1.99263216, 1.98885646, 1.98597262, 1.98457212, 1.98507973,
         1.98770173, 1.99240041, 1.99889862, 2.00671364, 2.01521539,
         2.02370078, 2.03147446, 2.03792639, 2.04259781, 2.04522938,
         2.04578754],
        [1.95876474, 1.96050782, 1.96437342, 1.97029569, 1.97762104,
         1.98588547, 1.99440348, 2.00234323, 2.00930542, 2.01464258,
         2.018016  , 2.01930455, 2.01861634, 2.0162773 , 2.01279781,
         2.00892331, 2.00515153, 2.00227439, 2.00088388, 2.00140496,
         2.00404318, 2.00875887, 2.01527205, 2.02309705, 2.03160153,
         2.04008163, 2.04784293, 2.05427781, 2.05893071, 2.06154538,
         2.06209048]]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>RL_low</span></div><div class='xr-var-dims'>(record_id, ReturnPeriod, Year)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>1.53 1.523 1.528 ... 1.96 1.959</div><input id='attrs-a259bad4-7de2-4a3f-9f64-fd7b3f9c6dec' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-a259bad4-7de2-4a3f-9f64-fd7b3f9c6dec' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-2fa651fe-a141-4517-a6e8-c569704f224b' class='xr-var-data-in' type='checkbox'><label for='data-2fa651fe-a141-4517-a6e8-c569704f224b' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[[1.53003573, 1.52312742, 1.52773245, 1.53423916, 1.51796821,
         1.528523  , 1.5471733 , 1.54556602, 1.54223767, 1.53541464,
         1.54036812, 1.54159212, 1.54802915, 1.55173891, 1.5590224 ,
         1.56685138, 1.55767568, 1.56489149, 1.57588409, 1.57140338,
         1.57548464, 1.57447376, 1.56206235, 1.5746589 , 1.58635558,
         1.58772108, 1.58443269, 1.59542706, 1.60428029, 1.60900824,
         1.59382529],
        [1.6068489 , 1.59401929, 1.60068154, 1.61828472, 1.57159379,
         1.58426468, 1.6417376 , 1.63271639, 1.62045719, 1.60042836,
         1.6076336 , 1.6078251 , 1.61683539, 1.62130377, 1.63106515,
         1.65027721, 1.62193777, 1.62686031, 1.66029789, 1.64486407,
         1.65018088, 1.64364513, 1.61127787, 1.62899549, 1.65906626,
         1.65601996, 1.64716407, 1.66419793, 1.68418255, 1.69006054,
         1.64900239],
        [1.65185442, 1.63275777, 1.6400535 , 1.67418594, 1.58891775,
         1.60208716, 1.71327403, 1.69386718, 1.67084516, 1.63456955,
         1.64425945, 1.64406783, 1.65505774, 1.65965441, 1.67096163,
         1.70772505, 1.65322419, 1.6531507 , 1.72072727, 1.690599  ,
         1.69753887, 1.68364554, 1.6268515 , 1.64753326, 1.70452277,
         1.69367646, 1.68019574, 1.70255024, 1.73946747, 1.74626601,
...
         1.85185873, 1.86378262, 1.87480459, 1.88397583, 1.89039894,
         1.89356799, 1.89333401, 1.88991195, 1.88386417, 1.87605424,
         1.86761053, 1.85962578, 1.85329526, 1.84959298, 1.8491957 ,
         1.8523956 , 1.85906098, 1.86865127, 1.88028462, 1.89284876,
         1.90513972, 1.91600856, 1.92449348, 1.92991788, 1.93194581,
         1.93060049],
        [1.8487548 , 1.84420673, 1.84657384, 1.85325144, 1.86285696,
         1.87421069, 1.88604184, 1.8970592 , 1.90629452, 1.91283772,
         1.91614784, 1.91603699, 1.91268912, 1.90664946, 1.8987776 ,
         1.89019473, 1.8820335 , 1.87549342, 1.871567  , 1.87094708,
         1.87393714, 1.88041233, 1.88983768, 1.90134028, 1.91382285,
         1.92610012, 1.93703703, 1.9456698 , 1.95129826, 1.95354651,
         1.9523952 ],
        [1.85623296, 1.85142992, 1.85366127, 1.86025408, 1.8698133 ,
         1.88114352, 1.89296809, 1.9039959 , 1.91324718, 1.91980998,
         1.92313641, 1.92303183, 1.91967506, 1.91360844, 1.90569108,
         1.89704045, 1.88880603, 1.8821889 , 1.87818984, 1.87750877,
         1.88045322, 1.88689894, 1.89630919, 1.90780885, 1.92029953,
         1.93259606, 1.94356321, 1.95223488, 1.95790558, 1.96019207,
         1.95906753]]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>RL_high</span></div><div class='xr-var-dims'>(record_id, ReturnPeriod, Year)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>1.687 1.71 1.689 ... 2.163 2.165</div><input id='attrs-1d5c948f-fa5e-4cd5-bac0-627926755a46' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-1d5c948f-fa5e-4cd5-bac0-627926755a46' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-139af4d3-f47e-40e9-86f9-cc0aa1771087' class='xr-var-data-in' type='checkbox'><label for='data-139af4d3-f47e-40e9-86f9-cc0aa1771087' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[[1.68723826, 1.70983178, 1.68865185, 1.6707619 , 1.75837862,
         1.71893047, 1.64659151, 1.66929165, 1.70095422, 1.74982246,
         1.74638041, 1.75460951, 1.73615421, 1.74016105, 1.71695909,
         1.69998358, 1.76465953, 1.74254264, 1.70701376, 1.74701627,
         1.74822289, 1.77150179, 1.84811043, 1.80534986, 1.76169356,
         1.7809747 , 1.81400579, 1.77520223, 1.75221609, 1.75125315,
         1.84041379],
        [1.91101722, 1.94766057, 1.91470422, 1.8661987 , 2.03356859,
         1.98526803, 1.81101149, 1.85116295, 1.90716986, 1.9933895 ,
         1.98824569, 1.99656217, 1.9653524 , 1.96907786, 1.93429289,
         1.88604456, 2.00807313, 1.98723824, 1.88886741, 1.95930248,
         1.96057129, 2.00034576, 2.13732581, 2.07783389, 1.97280473,
         2.00994661, 2.06294886, 1.99902596, 1.94421928, 1.94260042,
         2.10510459],
        [2.1069794 , 2.15740452, 2.11926218, 2.03435664, 2.28623198,
         2.23923817, 1.94700353, 2.00591929, 2.08484693, 2.20761519,
         2.20075662, 2.20780512, 2.16822303, 2.17270854, 2.13194183,
         2.04536473, 2.22803309, 2.21749078, 2.0417406 , 2.14278766,
         2.14352359, 2.20031325, 2.39682209, 2.33098469, 2.15498456,
         2.21349491, 2.28048804, 2.19885246, 2.10673551, 2.10518463,
...
         1.99414121, 1.99926664, 2.00417285, 2.0090175 , 2.01337638,
         2.01705914, 2.01995723, 2.02206358, 2.02346675, 2.02432786,
         2.02503336, 2.02545   , 2.02598438, 2.026844  , 2.02820142,
         2.0301804 , 2.03284493, 2.03619217, 2.04014997, 2.044579  ,
         2.04927997, 2.0540075 , 2.05849397, 2.06248606, 2.06578901,
         2.06830383],
        [2.03613199, 2.04413628, 2.04946706, 2.054605  , 2.05962578,
         2.06478947, 2.06999869, 2.07487802, 2.07959782, 2.08376503,
         2.08723678, 2.08995353, 2.0919448 , 2.09331709, 2.09423305,
         2.09506959, 2.09567941, 2.09645181, 2.09757724, 2.09921239,
         2.10146633, 2.1043885 , 2.10795956, 2.11208699, 2.11660793,
         2.12130143, 2.12591188, 2.13018297, 2.13389736, 2.13691224,
         2.13917989],
        [2.06129653, 2.06958571, 2.07508557, 2.08033729, 2.08542878,
         2.09062741, 2.09583887, 2.10069056, 2.10536367, 2.10947518,
         2.11289558, 2.11557727, 2.11755761, 2.11894615, 2.11990455,
         2.12080617, 2.12149703, 2.12235987, 2.12357791, 2.12530116,
         2.12763313, 2.1306188 , 2.13423492, 2.13838524, 2.14290354,
         2.1475672 , 2.15212266, 2.15632074, 2.15995584, 2.1628987 ,
         2.16511343]]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>x</span></div><div class='xr-var-dims'>(record_id, x_dim)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>1 1 0 1 0 1 0 1 ... 1 1 1 0 1 0 0 1</div><input id='attrs-5635372a-a036-4925-8bf6-0634dc61a3af' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-5635372a-a036-4925-8bf6-0634dc61a3af' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-7e571498-9b23-48b7-a187-a4c37b2d1e05' class='xr-var-data-in' type='checkbox'><label for='data-7e571498-9b23-48b7-a187-a4c37b2d1e05' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[1, 1, 0, 1, 0, 1, 0],
       [1, 0, 1, 0, 0, 0, 1],
       [1, 1, 0, 1, 0, 0, 0],
       [1, 1, 0, 1, 0, 0, 1],
       [1, 1, 0, 1, 0, 1, 1],
       [1, 1, 0, 1, 1, 0, 0],
       [1, 1, 0, 1, 1, 0, 1],
       [1, 1, 0, 1, 0, 0, 1]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>lat</span></div><div class='xr-var-dims'>(record_id)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>28.22 16.75 20.03 ... 19.73 21.43</div><input id='attrs-11d21884-258a-4ac3-a529-a0ab849d44d3' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-11d21884-258a-4ac3-a529-a0ab849d44d3' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-974b0ab0-a40d-4861-8d8e-e17f3a88b3f5' class='xr-var-data-in' type='checkbox'><label for='data-974b0ab0-a40d-4861-8d8e-e17f3a88b3f5' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([28.217, 16.75 , 20.033, 21.307, 21.967, 20.9  , 19.733, 21.433],
      dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>lon</span></div><div class='xr-var-dims'>(record_id)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>182.6 190.5 204.2 ... 204.9 202.2</div><input id='attrs-3e724274-b168-44aa-9cf3-f3c4c7c85b33' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-3e724274-b168-44aa-9cf3-f3c4c7c85b33' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-17d7271f-3214-4241-b7f7-492d9aa7bcb2' class='xr-var-data-in' type='checkbox'><label for='data-17d7271f-3214-4241-b7f7-492d9aa7bcb2' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([182.633, 190.483, 204.167, 202.133, 200.65 , 203.533, 204.933,
       202.2  ], dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>MHHW</span></div><div class='xr-var-dims'>(record_id)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>1.204 1.225 1.406 ... 1.912 1.533</div><input id='attrs-516ee54c-3545-4e48-9ecf-0f68fc8df02d' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-516ee54c-3545-4e48-9ecf-0f68fc8df02d' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-1900e494-a4c4-454d-8b87-515472378ae7' class='xr-var-data-in' type='checkbox'><label for='data-1900e494-a4c4-454d-8b87-515472378ae7' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([1.204, 1.225, 1.406, 1.722, 1.24 , 1.364, 1.912, 1.533])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>station_name</span></div><div class='xr-var-dims'>(record_id)</div><div class='xr-var-dtype'>&lt;U17</div><div class='xr-var-preview xr-preview'>&#x27;Midway&#x27; &#x27;Johnston&#x27; ... &#x27;Mokuoloe&#x27;</div><input id='attrs-35c9578a-956f-4add-8ea9-b6528bad67c6' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-35c9578a-956f-4add-8ea9-b6528bad67c6' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-f2bf2cad-76bc-45a8-b904-787b07a2e07f' class='xr-var-data-in' type='checkbox'><label for='data-f2bf2cad-76bc-45a8-b904-787b07a2e07f' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;Midway&#x27;, &#x27;Johnston&#x27;, &#x27;Kawaihae&#x27;, &#x27;Honolulu, Hawaii&#x27;, &#x27;Nawiliwili&#x27;,
       &#x27;Kahului&#x27;, &#x27;Hilo, Hawaii&#x27;, &#x27;Mokuoloe&#x27;], dtype=&#x27;&lt;U17&#x27;)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-a67b7de0-799f-4264-ac92-c4438f1650b3' class='xr-section-summary-in' type='checkbox'  ><label for='section-a67b7de0-799f-4264-ac92-c4438f1650b3' class='xr-section-summary' >Indexes: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-index-name'><div>record_id</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-dd27db1f-cc1b-4422-9bf5-a6cdd72653ed' class='xr-index-data-in' type='checkbox'/><label for='index-dd27db1f-cc1b-4422-9bf5-a6cdd72653ed' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([50, 52, 552, 57, 58, 59, 60, 61], dtype=&#x27;int64&#x27;, name=&#x27;record_id&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>Year</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-65c4115f-8792-4454-ae62-d287f4cedb2e' class='xr-index-data-in' type='checkbox'/><label for='index-65c4115f-8792-4454-ae62-d287f4cedb2e' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([1993.0, 1994.0, 1995.0, 1996.0, 1997.0, 1998.0, 1999.0, 2000.0, 2001.0,
       2002.0, 2003.0, 2004.0, 2005.0, 2006.0, 2007.0, 2008.0, 2009.0, 2010.0,
       2011.0, 2012.0, 2013.0, 2014.0, 2015.0, 2016.0, 2017.0, 2018.0, 2019.0,
       2020.0, 2021.0, 2022.0, 2023.0],
      dtype=&#x27;float64&#x27;, name=&#x27;Year&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>ReturnPeriod</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-d41960e9-9c64-41cc-a31d-b9aed9f043b4' class='xr-index-data-in' type='checkbox'/><label for='index-d41960e9-9c64-41cc-a31d-b9aed9f043b4' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([2, 10, 50, 100], dtype=&#x27;int64&#x27;, name=&#x27;ReturnPeriod&#x27;))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-c8848d63-4feb-4995-8656-c53cd8b53fec' class='xr-section-summary-in' type='checkbox'  checked><label for='section-c8848d63-4feb-4995-8656-c53cd8b53fec' class='xr-section-summary' >Attributes: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'><dt><span>description :</span></dt><dd>Time-dependent return values for the GEV model with seasonality, trend, covariate in location and scale, and nodal cycle in location. The x attribute is the binary array of parameters used in the model, where the first 3 elements are the seasonal parameters, the 4th element is the long-term trend, the 5th element is the covariate in location, the 6th element is the covariate in scale, and the 7th element is the nodal cycle.</dd><dt><span>datum :</span></dt><dd>STND</dd><dt><span>units :</span></dt><dd>m</dd></dl></div></li></ul></div></div></div></div>
</div>
</section>
<section id="create-a-map">
<h2>Create a Map<a class="headerlink" href="#create-a-map" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crs</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">crs</span><span class="p">})</span>
<span class="c1"># make ax,fig</span>
<span class="c1"># open the cmems data</span>

<span class="n">xlims</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">179</span><span class="p">,</span> <span class="o">-</span><span class="mi">152</span><span class="p">]</span>
<span class="n">ylims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>

<span class="n">scatters</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># plt.colorbar(maxplt,ax=axs[0],label=&#39;Sea Level (m)&#39;, location=&#39;bottom&#39;)           </span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">):</span>

    <span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">combined_ds</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">combined_ds</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> 
               <span class="n">c</span><span class="o">=</span><span class="n">combined_ds</span><span class="p">[</span><span class="s1">&#39;ReturnLevel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">Year</span><span class="o">=</span><span class="mi">2020</span><span class="p">)[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">combined_ds</span><span class="p">[</span><span class="s1">&#39;MHHW&#39;</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;YlOrRd&#39;</span><span class="p">,</span>
               <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">scatters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COASTLINE</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAND</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">)</span>

    <span class="c1"># set extent</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">([</span><span class="n">xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylims</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>

    <span class="c1">#add grid</span>
    <span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">draw_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                      <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">xlocs</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">(),</span><span class="n">ylocs</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">bottom_labels</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">left_labels</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1">#make all labels tiny</span>
    <span class="n">gl</span><span class="o">.</span><span class="n">xlabel_style</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>
    <span class="n">gl</span><span class="o">.</span><span class="n">ylabel_style</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>

    <span class="c1"># add text to top left of plot</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ReturnPeriod</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">-year flood: 2020&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># add colorbar to the bottom of the plot which follows vmin, vmax and cmap of the scatter plot</span>
<span class="c1"># colorbar should be </span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">extend</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Meters above MHHW&#39;</span><span class="p">)</span>

<span class="c1"># set the limits of the colorbar</span>
<span class="k">for</span> <span class="n">scatter</span> <span class="ow">in</span> <span class="n">scatters</span><span class="p">:</span>
    <span class="n">scatter</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>


<span class="c1"># save the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s1">&#39;TimeDependentReturnValueMap.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;TimeDependentReturnValueMap&quot;</span><span class="p">,</span><span class="n">fig</span><span class="p">,</span><span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<img alt="../../_images/900cacbe248043a058c754ac6f94fcbb0a670feb4644ddc23e57f01bfbf3f905.png" src="../../_images/900cacbe248043a058c754ac6f94fcbb0a670feb4644ddc23e57f01bfbf3f905.png" />
</div>
</details>
</div>
<figure class="align-default" id="timedependentreturnvaluemap">
<img alt="../../_images/900cacbe248043a058c754ac6f94fcbb0a670feb4644ddc23e57f01bfbf3f905.png" src="../../_images/900cacbe248043a058c754ac6f94fcbb0a670feb4644ddc23e57f01bfbf3f905.png" />
<figcaption>
<p><span class="caption-number">Fig. 11 </span><span class="caption-text">Map of the nonstationary GEV-based extreme water level return values for Hawaiian Island region stations. Year 2020 is shown here. Each nonstationary model includes some combination of seasonality, a long-term trend, and the 18.6 nodal-cycle, provided each parameter improves the significance of the GEV fit. No covariates are used for these particular best-fit models.</span><a class="headerlink" href="#timedependentreturnvaluemap" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crs</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">crs</span><span class="p">})</span>
<span class="c1"># make ax,fig</span>
<span class="c1"># open the cmems data</span>

<span class="n">xlims</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">179</span><span class="p">,</span> <span class="o">-</span><span class="mi">152</span><span class="p">]</span>
<span class="n">ylims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>

<span class="n">scatters</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># plt.colorbar(maxplt,ax=axs[0],label=&#39;Sea Level (m)&#39;, location=&#39;bottom&#39;)           </span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">):</span>

    <span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">combined_ds</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">combined_ds</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> 
               <span class="n">c</span><span class="o">=</span><span class="n">combined_ds</span><span class="p">[</span><span class="s1">&#39;ReturnLevel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">Year</span><span class="o">=</span><span class="mi">2020</span><span class="p">)[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">combined_ds</span><span class="p">[</span><span class="s1">&#39;ReturnLevel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">Year</span><span class="o">=</span><span class="mi">2008</span><span class="p">)[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;YlOrRd&#39;</span><span class="p">,</span>
               <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">scatters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COASTLINE</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAND</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">)</span>

    <span class="c1"># set extent</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">([</span><span class="n">xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylims</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>

    <span class="c1">#add grid</span>
    <span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">draw_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                      <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">xlocs</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">(),</span><span class="n">ylocs</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">bottom_labels</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">left_labels</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1">#make all labels tiny</span>
    <span class="n">gl</span><span class="o">.</span><span class="n">xlabel_style</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>
    <span class="n">gl</span><span class="o">.</span><span class="n">ylabel_style</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>

    <span class="c1"># add text to top left of plot</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ReturnPeriod</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">-year flood: 2020-2008 difference&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># add colorbar to the bottom of the plot which follows vmin, vmax and cmap of the scatter plot</span>
<span class="c1"># colorbar should be </span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">extend</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Meters above MHHW&#39;</span><span class="p">)</span>

<span class="c1"># set the limits of the colorbar</span>
<span class="k">for</span> <span class="n">scatter</span> <span class="ow">in</span> <span class="n">scatters</span><span class="p">:</span>
    <span class="n">scatter</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>


<span class="c1"># save the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s1">&#39;TimeDependentReturnValueMap2008.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

<span class="n">glue</span><span class="p">(</span><span class="s2">&quot;TimeDependentReturnValueMap2008&quot;</span><span class="p">,</span><span class="n">fig</span><span class="p">,</span><span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/76096c9f09650adcb8df9a78df264922d8b3b79ef8ae8fef0a46129196b59950.png" src="../../_images/76096c9f09650adcb8df9a78df264922d8b3b79ef8ae8fef0a46129196b59950.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "jwfiedler/SL_Hawaii",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks\nonstationaryGEV"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../regional_and_local/SL_Components_annual.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Components of Sea Level</p>
      </div>
    </a>
    <a class="right-next"
       href="../Flood.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Minor Flood Frequency and Duration</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cumulative-distribution-function-cdf">Cumulative Distribution Function (CDF)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#main-functions">Main Functions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-wise-solver">Step-wise solver</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#maximum-likelihood-estimation">Maximum Likelihood Estimation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-search">Parameter Search</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonality-in-location-model">Seasonality in Location Model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonality-trend-and-covariate-model">Seasonality, Trend, and Covariate Model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonality-trend-covariate-and-nodal-cycle-model">Seasonality, Trend, Covariate and Nodal cycle Model</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#input-to-the-fitness-function">Input to the fitness function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-seasonality-effect-on-extremes">Plot: Seasonality Effect on Extremes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#format-data-input-to-the-model">Format data input to the model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adjust-data-for-storm-year">Adjust data for storm year</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-the-covariate-data-timeseries">Prepare the covariate data timeseries.</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#first-look-modeling-seasonality">First look: Modeling Seasonality</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-a-timeseries-of-the-time-dependent-return-values">Extract a timeseries of the time-dependent return values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-confidence-intervals">Calculate Confidence Intervals</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-the-time-dependent-return-value">Calculate the Time Dependent Return Value</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-monthly-extremes-and-given-year-return-period-with-the-seasonal-model">Plot monthly extremes and given year return period with the seasonal model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-if-we-should-include-a-long-term-trend-mean-sea-level-rise-in-our-location-parameter">Check if we should include a long-term trend (mean sea level rise) in our location parameter</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-covariate-in-the-location-parameter">Check the covariate in the location parameter.</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-covariate-in-scale-parameter">Check the covariate in scale parameter</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-nodal-cycle-in-location-parameter">Check the nodal cycle in Location parameter</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-the-timeseries">Plot the timeseries</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-it-up">Plot it up</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-combined-dataset-for-further-plotting-and-analysis">Create a combined dataset for further plotting and analysis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-map">Create a Map</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Playground Coordinator
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>